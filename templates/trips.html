{% extends "base.html" %}
{% load static %}

{% block title %}Our Tours & Experiences â€” Nile Dreams{% endblock %}

{% block content %}
{% if destination_hero %}
<section id="page-top" class="relative isolate overflow-hidden bg-black text-white scroll-mt-32">
  {% if destination_hero.image_url %}
  <img src="{{ destination_hero.image_url }}" alt="{{ destination_hero.title }}" class="absolute inset-0 h-full w-full object-cover" />
  {% else %}
  <div class="absolute inset-0 bg-gradient-to-br from-primary/70 via-primary/60 to-black opacity-90"></div>
  {% endif %}
  <div class="absolute inset-0 bg-gradient-to-b from-black/25 via-black/10 to-black/50"></div>
  <div class="relative mx-auto max-w-7xl px-4 pb-28 pt-32 sm:px-6 lg:px-8">
    <div class="destination-hero-texts max-w-3xl space-y-6">
      <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-white/70">Destination spotlight</span>
      <h1 class="font-serif text-4xl leading-tight sm:text-5xl md:text-6xl">{{ destination_hero.title }}</h1>
      {% if destination_hero.subtitle %}
      <p class="destination-sub text-base leading-relaxed text-white/80 sm:text-lg">{{ destination_hero.subtitle }}</p>
      {% elif selected_destination and selected_destination.tagline %}
      <p class="text-base leading-relaxed text-white/80 sm:text-lg">{{ selected_destination.tagline }}</p>
      {% endif %}
    </div>
    <div class="trips-hero2 mt-12 flex flex-wrap gap-4">
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ total_trip_count }} itineraries
      </span>
      {% if selected_destination and selected_destination.tagline %}
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.343 7.657 12 12l-4.343-4.343" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.071 4.929A10 10 0 1 0 4.93 19.07 10 10 0 0 0 19.07 4.93Z" />
        </svg>
        {{ selected_destination.tagline }}
      </span>
      {% endif %}
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
        </svg>
        Thoughtfully paced journeys
      </span>
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ total_trip_count }} trips available
      </span>
    </div>
  </div>
</section>
{% elif default_trips_hero_image %}
<section id="page-top" class="relative isolate overflow-hidden bg-black text-white scroll-mt-32">
  <img src="{{ default_trips_hero_image }}" alt="Trips hero" class="absolute inset-0 h-full w-full object-cover" />
  <div class="absolute inset-0 bg-gradient-to-b from-black/25 via-black/10 to-black/60"></div>
  <div class="relative mx-auto max-w-7xl px-4 pb-28 pt-32 sm:px-6 lg:px-8">
    <div class="max-w-3xl space-y-6">
      <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-white/70">Our journeys</span>
      <h1 class="font-serif text-4xl leading-tight sm:text-5xl md:text-6xl">Our Tours &amp; Experiences</h1>
      <p class="text-base leading-relaxed text-white/80 sm:text-lg">Carefully curated journeys to unveil the wonders of Egypt.</p>
    </div>
    <div class="mt-12 flex flex-wrap gap-4">
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ total_trip_count }} itineraries
      </span>
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
        </svg>
        Thoughtfully paced journeys
      </span>
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ total_trip_count }} trips available
      </span>
    </div>
  </div>
</section>
{% else %}
<section id="page-top" class="relative isolate overflow-hidden bg-background">
  <div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-accent/10 to-primary/5"></div>
  <div class="relative mx-auto max-w-7xl px-4 pb-28 pt-32 sm:px-6 lg:px-8">
    <div class="max-w-3xl space-y-6 text-center sm:text-left">
      <span class="inline-flex items-center justify-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Our journeys</span>
      <h1 class="font-serif text-4xl leading-tight text-foreground sm:text-5xl md:text-6xl">Our Tours &amp; Experiences</h1>
      <p class="text-base leading-relaxed text-muted-foreground sm:text-lg">Carefully curated journeys to unveil the wonders of Egypt.</p>
      <div class="flex flex-wrap justify-center gap-3 sm:justify-start">
        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Trusted local experts</span>
        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Small group departures</span>
      </div>
    </div>
  </div>
</section>
{% endif %}

{% if selected_destination %}
<nav id="destination-nav" class="sticky top-16 z-30 border-b border-border/60 bg-background/95 py-3 shadow-sm backdrop-blur lg:py-4 tailwind-subnav" aria-label="Destination navigation">
  <div class="mx-auto flex max-w-7xl flex-col gap-3 px-4 text-sm text-muted-foreground sm:flex-row sm:items-center sm:justify-between sm:px-6 lg:px-8">
    <div class="subnav flex flex-wrap items-center gap-3">
      <a href="#destination-summary" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Overview</a>
      <a href="#trip-list" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Trips</a>
      {% if destination_gallery %}
      <a href="#destination-gallery" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Gallery</a>
      {% endif %}
      <a href="#contact" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Speak with us</a>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <div class="text-right text-[11px] uppercase tracking-[0.3em] text-muted-foreground">Speak with our travel team</div>
      <div class="flex items-center gap-2">
        {% for action in contact_actions %}
        {% if action.icon == "whatsapp" %}
        {% with destination_name=selected_destination.name|default:"this destination" %}
        {% with whatsapp_message="Hello Sand & Sky Tours, I would like to know more about the destination "|add:destination_name|add:"." %}
        <a href="https://wa.me/201108741159?text={{ whatsapp_message|urlencode }}" class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-card px-3 py-1.5 text-xs font-semibold text-foreground transition-colors hover:border-primary/40 hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" aria-label="{{ action.aria }}" target="_blank" rel="noopener">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-3.5 w-3.5 text-primary">
            <path d="M12.04 2a9.84 9.84 0 0 0-8.8 14.48L2 22l5.66-1.22A9.83 9.83 0 1 0 12.04 2Zm0 17.73c-1.57 0-3.11-.41-4.46-1.17l-.32-.18-3.36.72.72-3.26-.2-.33A7.86 7.86 0 1 1 12.04 19.73Zm4.38-5.83c-.24-.12-1.43-.7-1.65-.78-.22-.08-.38-.12-.54.12-.16.24-.62.78-.76.94-.14.16-.28.18-.52.06-.24-.12-1-.37-1.9-1.2-.7-.63-1.18-1.4-1.32-1.64-.14-.24-.02-.37.1-.49.1-.09.24-.24.36-.36.12-.12.16-.2.24-.34.08-.14.04-.27-.02-.39-.06-.12-.54-1.31-.74-1.79-.2-.48-.4-.41-.54-.42h-.46c-.16 0-.4.06-.62.3-.22.24-.84.82-.84 2s.86 2.36.98 2.52c.12.16 1.7 2.6 4.12 3.65.58.25 1.03.4 1.38.52.58.18 1.12.16 1.54.1.47-.07 1.43-.58 1.63-1.14.2-.56.2-1.04.14-1.14-.06-.1-.22-.16-.46-.28Z" />
          </svg>
          <span>{{ action.label }}</span>
        </a>
        {% endwith %}
        {% endwith %}
        {% else %}
        <a href="{{ action.href }}" class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-card px-3 py-1.5 text-xs font-semibold text-foreground transition-colors hover:border-primary/40 hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" aria-label="{{ action.aria }}">
          {% if action.icon == "phone" %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path d="M6.5 3h2l1.5 4-2 1c1 2.5 2.9 4.4 5.4 5.4l1-2 4 1.5v2c0 1-1 2-2 2A14 14 0 0 1 4.5 5c0-1 1-2 2-2Z" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          {% elif action.icon == "mail" %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 5h15a1.5 1.5 0 0 1 1.5 1.5v11a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 17.5v-11A1.5 1.5 0 0 1 4.5 5Zm0 0 7.5 6 7.5-6" />
          </svg>
          {% else %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14" />
          </svg>
          {% endif %}
          <span>{{ action.label }}</span>
        </a>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</nav>

<section id="destination-summary" class="whytext why scroll-mt-32 bg-secondary/30 px-4 py-20 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-7xl">
    <div class=" space-y-8">
      <div class="space-y-5 text-left">
        <div class="why-img">
          <p class="whytext2 text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Why visit {{ selected_destination.name }}</p>
        </div>
        {% if selected_destination.description %}
        <p class="whytext3 text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ selected_destination.description }}</p>
        {% else %}
        <p class="text-lg leading-relaxed text-muted-foreground">Discover curated journeys designed to reveal the essence of {{ selected_destination.name }} with expert guides and seamless planning.</p>
        {% endif %}
      </div>
      <div class="space-y-5 text-left">
        <p class="whytext4 text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Trip style</p>
        {% if destination_hero and destination_hero.subtitle %}
        <p class="whytext5 text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ destination_hero.subtitle }}</p>
        {% elif selected_destination.tagline %}
        <p class="text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ selected_destination.tagline }}</p>
        {% else %}
        <p class="text-lg leading-relaxed text-muted-foreground">Handcrafted journeys that balance iconic highlights with local secrets.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endif %}

<section id="trip-list" class="trips-head scroll-mt-32 bg-secondary/30 px-4 pt-20 pb-24 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-7xl lg:grid lg:grid-cols-[minmax(0,1fr)_280px] lg:gap-12">
    <div id="trip-results" class="space-y-10" aria-live="polite">
      <div class="space-y-4 text-center md:text-left">
        <div class="desti">
          <h2 class="tripsin1 font-serif text-3xl text-foreground sm:text-4xl">
            {% if selected_destination %}
            Trips in {{ selected_destination.name }}
            {% else %}
            Available Tours
            {% endif %}
          </h2>
        </div>

        <p class="tripsin2 text-base leading-relaxed text-muted-foreground">
          {% if selected_destination %}
          Explore {{ total_trip_count }} hand-crafted itineraries designed to reveal the heart of {{ selected_destination.name }}. Each journey balances iconic highlights with quieter moments only locals know.
          {% else %}
          Explore {{ total_trip_count }} journeys crafted by our Egypt specialists. Every itinerary blends essential sights with authentic experiences and seamless service.
          {% endif %}
        </p>
      </div>

      <div class="mt-6 flex items-center justify-between gap-3 lg:hidden">
        <button type="button"
                class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-card px-4 py-2 text-sm font-semibold text-foreground shadow-sm transition hover:border-primary/40 hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                data-filter-open
                aria-controls="trip-filter-panel"
                aria-expanded="false"
                aria-haspopup="dialog">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18M6 12h12M10 19h4" />
          </svg>
          <span>Filters</span>
        </button>
      </div>

      {% if trips %}
      <div class="flex flex-wrap items-center justify-center gap-3 md:justify-end">
        <span class="text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground">View</span>
        <div class="trip-view-toggle" data-trip-view-toggle role="group" aria-label="Choose trips layout">
          <button type="button" class="trip-view-toggle__btn is-active" data-view="grid" aria-pressed="true">Grid</button>
          <button type="button" class="trip-view-toggle__btn" data-view="list" aria-pressed="false">List</button>
        </div>
      </div>
      <div class="trip-grid grid gap-10 sm:grid-cols-2 xl:grid-cols-3" data-trip-grid>
        {% for trip in trips %}
        <article class="trip-cardi max-h-[520px] group flex h-full flex-col overflow-hidden rounded-md border border-border/40">
          {% if trip.category %}
          <span class="trip-card__badge">{{ trip.category }}</span>
          {% endif %}
          <div class="relative h-48 overflow-hidden">
            {% if trip.image_url %}
            <img src="{{ trip.image_url }}" alt="{{ trip.title }}" class="h-full w-full object-cover" />
            {% else %}
            <div class="flex h-full items-center justify-center bg-muted text-muted-foreground">
              <span class="text-sm font-semibold uppercase tracking-wide">Image coming soon</span>
            </div>
            {% endif %}
          </div>

          <div class="flex flex-1 flex-col gap-4 p-4">
            {% if trip.languages %}
            <ul class="trip-card__languages" aria-label="Available languages">
              {% for language in trip.languages %}
              <li class="trip-card__language-chip">{{ language }}</li>
              {% endfor %}
            </ul>
            {% endif %}
            <header class="rounded-md px-2 py-1">
              <h3 class="font-serif text-lg leading-tight text-foreground">{{ trip.title }}</h3>
            </header>

            <div class="mt-auto space-y-4">
              <dl class="trip-card__meta grid grid-cols-1 gap-3 sm:grid-cols-2">
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Duration</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.duration }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Group size</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 17v-1a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v1" />
                    <circle cx="8" cy="7" r="3" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M22 17v-1a4 4 0 0 0-3-3.87" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a3 3 0 0 1-2 2.82" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.group_size }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Location</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10c0 7-7.5 11.5-7.5 11.5S4.5 17 4.5 10a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.location }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Starts from</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .843-3 1.882C9 10.92 10.343 11.764 12 11.764s3 .843 3 1.882S13.657 15.528 12 15.528s-3-.843-3-1.882" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14" />
                  </svg>
                  <dd class="trip-card__value trip-card__price text-[13px]">
                    <span class="trip-card__prefix text-muted-foreground">Starts from</span>
                    {{ trip.price }}
                  </dd>
                </div>
              </dl>

              <a href="{% url 'web:trip-detail' trip.slug %}"
                 class="trip-card__cta-primary inline-flex w-full items-center justify-center rounded-md px-3 py-2 text-xs sm:text-sm font-semibold shadow-sm transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
                View details
              </a>
              <form method="post" action="{% url 'web:booking-cart-quick-add' trip.slug %}" class="mt-2" data-cart-toggle>
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                {% with date_id="quick-add-date-"|add:trip.slug count_id="quick-add-count-"|add:trip.slug %}
                <div class="relative" data-quick-add-container>
                  <button type="submit"
                          class="trip-card__cta-secondary inline-flex w-full items-center justify-center rounded-md border px-3 py-2 text-xs sm:text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                          data-cart-toggle-button
                          data-cart-state="{% if trip.in_cart %}added{% else %}removed{% endif %}"
                          data-cart-class-added="trip-card__cta-secondary"
                          data-cart-class-removed="trip-card__cta-secondary"
                          aria-haspopup="dialog"
                          aria-expanded="false">
                    {% if trip.in_cart %}
                    Remove from booking list
                    {% else %}
                    Add to booking list
                    {% endif %}
                  </button>
                  <div class="quick-add-popover absolute left-0 right-0 z-30 mt-2 hidden rounded-xl border border-border bg-card p-4 shadow-subtle"
                       data-quick-add-popover
                       role="dialog"
                       aria-label="Quick add trip details"
                       aria-modal="false"
                       data-state="closed">
                    <div class="flex flex-col gap-4 text-left">
                      <div class="space-y-1">
                        <label for="{{ date_id }}" class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Travel date</label>
                        <input id="{{ date_id }}"
                               type="date"
                               name="date"
                               class="w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                               data-quick-add-date />
                      </div>
                      <div class="space-y-1">
                        <label for="{{ count_id }}" class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Travelers</label>
                        <div class="flex items-center gap-2">
                          <button type="button"
                                  class="flex h-9 w-9 items-center justify-center rounded-full border border-border/70 text-sm font-semibold text-muted-foreground transition hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                                  data-quick-add-step="down"
                                  aria-label="Decrease travelers">
                            -
                          </button>
                          <input id="{{ count_id }}"
                                 type="number"
                                 name="adults"
                                 min="1"
                                 max="16"
                                 value="2"
                                 class="h-9 w-14 rounded-md border border-border/70 bg-background text-center text-sm font-semibold text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                                 data-quick-add-count />
                          <button type="button"
                                  class="flex h-9 w-9 items-center justify-center rounded-full border border-border/70 text-sm font-semibold text-muted-foreground transition hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                                  data-quick-add-step="up"
                                  aria-label="Increase travelers">
                            +
                          </button>
                        </div>
                      </div>
                      <div class="flex items-center justify-end gap-2">
                        <button type="button"
                                class="inline-flex items-center rounded-md border border-border/60 px-3 py-1.5 text-xs font-semibold text-muted-foreground transition hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                                data-quick-add-cancel>
                          Cancel
                        </button>
                        <button type="submit"
                                class="inline-flex items-center rounded-md bg-primary px-3 py-1.5 text-xs font-semibold text-primary-foreground transition hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                                data-quick-add-confirm>
                          Add trip
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endwith %}
              </form>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
      {% if total_trip_count %}
      <div class="trip-pagination mt-12">
        <p class="trip-pagination__summary">Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_trip_count }} tours</p>
        {% if is_paginated %}
        <nav class="trip-pagination__nav" aria-label="Trips pagination">
          {% if page_obj.has_previous %}
          <a href="?{{ page_query_prefix }}page={{ page_obj.previous_page_number }}" class="trip-pagination__link" rel="prev">Previous</a>
          {% else %}
          <span class="trip-pagination__link trip-pagination__link--disabled" aria-disabled="true">Previous</span>
          {% endif %}
          <span class="trip-pagination__status">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
          {% if page_obj.has_next %}
          <a href="?{{ page_query_prefix }}page={{ page_obj.next_page_number }}" class="trip-pagination__link" rel="next">Next</a>
          {% else %}
          <span class="trip-pagination__link trip-pagination__link--disabled" aria-disabled="true">Next</span>
          {% endif %}
        </nav>
        {% endif %}
      </div>
      {% endif %}
      {% else %}
      <div class="mx-auto max-w-3xl rounded-3xl border border-dashed border-border bg-muted/50 p-12 text-center shadow-subtle">
        <h3 class="font-serif text-2xl text-foreground">No trips yet</h3>
        <p class="mt-3 text-base leading-relaxed text-muted-foreground">
          {% if selected_destination %}
          We have not published any trips for {{ selected_destination.name }} yet. Share your travel dreams and our specialists will design a bespoke itinerary.
          {% else %}
          New journeys will be published soon. Check back shortly or reach out to craft a private departure.
          {% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <aside id="trip-filter-panel"
           class="filter-bar mb-12 hidden space-y-6 rounded-2xl border border-border bg-card p-6 shadow-subtle lg:mb-0 lg:block lg:self-start lg:sticky lg:top-32"
           data-filter-panel
           data-mobile-state="closed"
           tabindex="-1"
           aria-hidden="true"
           aria-label="Trip filters">
      <div class="mobile-filter-header mb-4 flex items-center justify-between lg:hidden">
        <span class="text-sm font-semibold uppercase tracking-[0.25em] text-muted-foreground">Filters</span>
        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-border/60 px-3 py-1 text-xs font-semibold text-muted-foreground transition hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" data-filter-close>
          <span>Close</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="m6 6 12 12M18 6 6 18" />
          </svg>
        </button>
      </div>
      <form action="{% url 'web:trips' %}" method="get" class="filter-form space-y-6" data-live-filter>
        <div class="space-y-1">
          <h3 class="text-sm font-semibold uppercase tracking-[0.25em] text-muted-foreground">Refine tours</h3>
          <p class="text-xs text-muted-foreground">Use filters to narrow itineraries.</p>
        </div>

        <div class="space-y-2">
          <label for="filter-search" class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Quick search</label>
          <input id="filter-search"
                 type="search"
                 name="search"
                 placeholder="Search by keyword"
                 value="{{ active_filters.search }}"
                 class="w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                 data-filter-search
                 autocomplete="off"
                 spellcheck="false" />
        </div>

        <div class="space-y-2">
          <label for="filter-destination" class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Destination</label>
          <select id="filter-destination" name="destination" class="w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
            <option value="">All destinations</option>
            {% for destination in filter_options.destinations %}
            <option value="{{ destination.slug }}" {% if active_filters.destination == destination.slug %}selected{% endif %}>{{ destination.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="space-y-3">
          <span class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Price (per person)</span>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="filter-price-min" class="text-[11px] uppercase tracking-[0.2em] text-muted-foreground">Min</label>
              <input id="filter-price-min" type="number" name="price_min" placeholder="{{ filter_options.price.min|floatformat:0 }}" value="{% if active_filters.price_min %}{{ active_filters.price_min }}{% endif %}" class="mt-1 w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" min="0" step="50" />
            </div>
            <div>
              <label for="filter-price-max" class="text-[11px] uppercase tracking-[0.2em] text-muted-foreground">Max</label>
              <input id="filter-price-max" type="number" name="price_max" placeholder="{{ filter_options.price.max|floatformat:0 }}" value="{% if active_filters.price_max %}{{ active_filters.price_max }}{% endif %}" class="mt-1 w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" min="0" step="50" />
            </div>
          </div>
        </div>

        <fieldset class="space-y-3">
          <legend class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Duration</legend>
          <div class="space-y-2">
            {% for bucket in filter_options.durations %}
            <label class="flex items-center gap-3 text-sm text-muted-foreground">
              <input type="checkbox" name="duration" value="{{ bucket.value }}" class="h-4 w-4 rounded border-border/70 text-primary focus:ring-primary" {% if bucket.value in active_filters.duration_ranges %}checked{% endif %} />
              <span>{{ bucket.label }}</span>
            </label>
            {% endfor %}
          </div>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Group size</legend>
          <div class="space-y-2">
            {% for bucket in filter_options.group_sizes %}
            <label class="flex items-center gap-3 text-sm text-muted-foreground">
              <input type="checkbox" name="group_size" value="{{ bucket.value }}" class="h-4 w-4 rounded border-border/70 text-primary focus:ring-primary" {% if bucket.value in active_filters.group_sizes %}checked{% endif %} />
              <span>{{ bucket.label }}</span>
            </label>
            {% endfor %}
          </div>
        </fieldset>

        <div class="flex flex-wrap items-center gap-3">
          <button type="submit" class="filter-submit inline-flex items-center justify-center rounded-full px-5 py-2 text-sm font-semibold shadow-subtle transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Apply filters</button>
          <a href="{% url 'web:trips' %}" class="filter-reset text-sm font-semibold transition" data-filter-reset>Reset</a>
        </div>
      </form>
    </aside>
    <div class="fixed inset-0 z-40 hidden bg-black/40 backdrop-blur-sm" data-filter-overlay></div>
  </div>
</section>
{% if destination_gallery %}
{% with dest_name=selected_destination.name|default:"Egypt" %}
{% include "includes/destination_gallery.html" with section_id="destination-gallery" gallery_items=destination_gallery destination_name=dest_name alt_prefix=dest_name eyebrow="Gallery" title=dest_name|add:" Gallery" %}
{% endwith %}
{% endif %}
{% endblock %}



{% block scripts %}
<style>

  .why {
    background-color: #EBE2D3;
  }

  body.filter-panel-open {
    overflow: hidden;
  }

  [data-filter-overlay] {
    opacity: 0;
    transition: opacity .2s ease;
  }

  [data-filter-overlay].is-visible {
    opacity: 1;
  }

  @media (max-width: 1023px) {
    .filter-bar[data-mobile-state="open"] {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 50;
      display: block;
      max-width: none;
      border-radius: 0;
      height: 100vh;
      overflow-y: auto;
      padding: calc(1.5rem + env(safe-area-inset-top, 0px)) 1.5rem calc(2.5rem + env(safe-area-inset-bottom, 0px));
      -webkit-overflow-scrolling: touch;
      background: rgba(247, 240, 230, 0.98);
    }

    .filter-bar[data-mobile-state="open"] .filter-form {
      max-width: 32rem;
      margin: 0 auto;
    }

    .filter-bar[data-mobile-state="open"] .mobile-filter-header {
      position: sticky;
      top: calc(-1.5rem - env(safe-area-inset-top, 0px));
      margin: calc(-1.5rem - env(safe-area-inset-top, 0px)) -1.5rem 1.5rem;
      padding: calc(1.5rem + env(safe-area-inset-top, 0px)) 1.5rem 1rem;
      background: rgba(247, 240, 230, 0.96);
      backdrop-filter: blur(12px);
      z-index: 1;
    }
  }

  @media (min-width: 640px) and (max-width: 1023px) {
    .filter-bar[data-mobile-state="open"] {
      left: auto;
      width: min(26rem, 90vw);
      border-radius: 1.5rem 0 0 1.5rem;
      box-shadow: 0 24px 48px rgba(17, 17, 17, 0.28);
    }

    .filter-bar[data-mobile-state="open"] .mobile-filter-header {
      margin-left: 0;
      margin-right: 0;
    }
  }

  @media (min-width: 1024px) {
    .filter-bar {
      position: sticky;
      top: 7.5rem;
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }
  }

  .trip-cardi {
    background: #EBE2D3;
    border-color: rgba(17,17,17,.08);
    box-shadow: 0 6px 16px -12px rgba(24,24,24,0.45);
    transition: box-shadow .25s ease, transform .25s ease;
  }

  .trip-cardi.quick-add-active {
    z-index: 50;
    overflow: visible;
    transform: none !important;
  }

  .trip-grid.trip-grid--list .trip-cardi {
    overflow: visible;
  }

  .trip-grid.trip-grid--list [data-quick-add-container].quick-add-open {
    z-index: 40;
  }

  .trip-grid.trip-grid--list [data-quick-add-container].quick-add-open .quick-add-popover {
    left: auto;
    right: 0;
    min-width: 18rem;
  }

  @media (max-width: 767px) {
    .trip-grid.trip-grid--list [data-quick-add-container].quick-add-open .quick-add-popover {
      left: 0;
      right: 0;
      min-width: auto;
    }
  }

  .trip-cardi:hover {
    box-shadow: 0 10px 24px -12px rgba(24,24,24,0.55);
    transform: translateY(-2px);
  }

  .trip-card__languages{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin:0;
    padding:0 0 4px;
    list-style:none;
  }

  .trip-card__language-chip{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(201,169,97,0.18);
    color:#5a4727;
    font:600 10px/1 Inter,system-ui;
    letter-spacing:.18em;
    text-transform:uppercase;
    border:1px solid rgba(201,169,97,0.36);
  }

  .trip-cardi .trip-card__price {
    color: var(--primary);
    font-weight: 600;
  }

  .trip-cardi .trip-card__prefix {
    color: rgba(17,17,17,0.55);
    font-weight: 500;
  }

  .trip-card__cta-primary {
    background: linear-gradient(90deg, rgba(201,169,97,0.95), rgba(201,169,97,0.8));
    color: #1f1b12;
    border: none;
    box-shadow: 0 10px 28px -16px rgba(201,169,97,0.65);
  }

  .trip-card__cta-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 34px -18px rgba(201,169,97,0.75);
  }

  .trip-card__cta-secondary {
    background: rgba(255,255,255,0.65);
    border-color: rgba(201,169,97,0.45);
    color: #7b5b2b;
    transition: background-color .2s ease, border-color .2s ease, color .2s ease, transform .2s ease;
  }

  .trip-card__cta-secondary:hover {
    background: rgba(201,169,97,0.15);
    border-color: rgba(201,169,97,0.6);
  }

  .trip-card__cta-secondary[data-cart-state="added"] {
    background: rgba(249, 218, 218, 0.8);
    color: #9f1239;
    border-color: rgba(220, 38, 38, 0.3);
  }

  .trip-card__cta-secondary[data-cart-state="added"]:hover {
    background: rgba(249, 218, 218, 0.95);
    border-color: rgba(220, 38, 38, 0.45);
  }

  .filter-bar {
    background: rgba(247, 240, 230, 0.9);
    border-color: rgba(17,17,17,0.06);
    box-shadow: 0 20px 44px -28px rgba(31, 27, 18, 0.45);
    backdrop-filter: blur(10px);
  }

  .filter-bar label,
  .filter-bar legend,
  .filter-bar h3 {
    color: rgba(31, 27, 18, 0.68);
  }

  .filter-bar input[type="number"],
  .filter-bar select {
    background: rgba(255,255,255,0.82);
    border-color: rgba(17,17,17,0.1);
    color: #1f1b12;
  }

  .filter-bar input[type="number"]:focus,
  .filter-bar select:focus {
    border-color: rgba(201,169,97,0.5);
    box-shadow: 0 0 0 2px rgba(201,169,97,0.15);
  }

  .filter-bar input[type="checkbox"] {
    border-color: rgba(17,17,17,0.14);
  }

  .filter-bar input[type="checkbox"]:checked {
    background-color: rgba(201,169,97,0.82);
    border-color: rgba(201,169,97,0.82);
  }

  .filter-bar input[type="checkbox"]:focus-visible {
    outline: 2px solid rgba(201,169,97,0.35);
    outline-offset: 2px;
  }

  .filter-submit {
    background: linear-gradient(90deg, rgba(201,169,97,1), rgba(201,169,97,0.82));
    color: #1f1b12;
    box-shadow: 0 12px 28px -18px rgba(201,169,97,0.65);
    border: none;
    transition: transform .2s ease, box-shadow .2s ease;
  }

  .filter-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 36px -18px rgba(201,169,97,0.75);
  }

  .filter-reset {
    color: rgba(102, 82, 47, 0.85);
  }

  .filter-reset:hover {
    color: rgba(201,169,97,0.95);
  }



</style>
{{ block.super }}
<script>
(function () {
  var hasPopstateListener = false;
  var BASE_SCROLL_OFFSET = 24;
  var TRIP_VIEW_STORAGE_KEY = 'trip-view-mode';
  var desktopMediaQuery = typeof window.matchMedia === 'function' ? window.matchMedia('(min-width: 1024px)') : null;
  var mobileFilterKeydownBound = false;
  var mobileFilterMediaBound = false;
  var mobileFilterMediaHandler = null;
  var previousMobileFilterFocus = null;

  function calculateScrollOffset(target) {
    var offset = BASE_SCROLL_OFFSET;
    var primaryNav = document.querySelector('nav.fixed');
    if (primaryNav) {
      offset += primaryNav.getBoundingClientRect().height;
    }

    var destinationNav = document.getElementById('destination-nav');
    if (destinationNav) {
      offset += destinationNav.getBoundingClientRect().height;
    }

    if (target && target.dataset && target.dataset.scrollOffset) {
      var customOffset = parseInt(target.dataset.scrollOffset, 10);
      if (!Number.isNaN(customOffset)) {
        offset += customOffset;
      }
    }

    return offset;
  }

  function scrollToSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (!section) {
      return false;
    }
    window.requestAnimationFrame(function () {
      var top = window.pageYOffset + section.getBoundingClientRect().top - calculateScrollOffset(section);
      window.scrollTo({ top: Math.max(top, 0), behavior: 'smooth' });
    });
    return true;
  }

  function smoothScrollToResults() {
    scrollToSection('trip-list');
  }

  function isDesktopView() {
    if (!desktopMediaQuery) {
      return window.innerWidth >= 1024;
    }
    return desktopMediaQuery.matches;
  }

  function openMobileFilterPanel() {
    if (isDesktopView()) {
      return;
    }
    var panel = document.querySelector('[data-filter-panel]');
    if (!panel || panel.dataset.mobileState === 'open') {
      return;
    }
    var overlay = document.querySelector('[data-filter-overlay]');
    previousMobileFilterFocus = document.activeElement;
    panel.dataset.mobileState = 'open';
    panel.classList.remove('hidden');
    panel.setAttribute('aria-hidden', 'false');
    panel.scrollTop = 0;
    if (overlay) {
      overlay.classList.remove('hidden');
      overlay.classList.add('is-visible');
    }
    var openButton = document.querySelector('[data-filter-open]');
    if (openButton) {
      openButton.setAttribute('aria-expanded', 'true');
    }
    document.body.classList.add('filter-panel-open');
    window.requestAnimationFrame(function () {
      panel.focus({ preventScroll: true });
    });
  }

  function closeMobileFilterPanel() {
    var panel = document.querySelector('[data-filter-panel]');
    if (!panel) {
      return;
    }
    panel.dataset.mobileState = 'closed';
    if (isDesktopView()) {
      panel.classList.remove('hidden');
      panel.setAttribute('aria-hidden', 'false');
    } else {
      panel.classList.add('hidden');
      panel.setAttribute('aria-hidden', 'true');
    }
    var overlay = document.querySelector('[data-filter-overlay]');
    if (overlay) {
      overlay.classList.add('hidden');
      overlay.classList.remove('is-visible');
    }
    var openButton = document.querySelector('[data-filter-open]');
    if (openButton) {
      openButton.setAttribute('aria-expanded', 'false');
    }
    document.body.classList.remove('filter-panel-open');
    if (previousMobileFilterFocus && typeof previousMobileFilterFocus.focus === 'function') {
      previousMobileFilterFocus.focus({ preventScroll: true });
    }
    previousMobileFilterFocus = null;
  }

  function initMobileFilters() {
    var panel = document.querySelector('[data-filter-panel]');
    var openButton = document.querySelector('[data-filter-open]');
    var overlay = document.querySelector('[data-filter-overlay]');
    if (!panel) {
      return;
    }

    if (!panel.dataset.mobileState) {
      panel.dataset.mobileState = 'closed';
    }

    if (isDesktopView()) {
      panel.classList.remove('hidden');
      panel.setAttribute('aria-hidden', 'false');
      panel.dataset.mobileState = 'closed';
      if (overlay) {
        overlay.classList.add('hidden');
        overlay.classList.remove('is-visible');
      }
    } else if (panel.dataset.mobileState !== 'open') {
      panel.classList.add('hidden');
      panel.setAttribute('aria-hidden', 'true');
    }

    if (openButton) {
      openButton.setAttribute('aria-expanded', panel.dataset.mobileState === 'open' ? 'true' : 'false');
      if (!openButton.dataset.filterMobileBound) {
        openButton.dataset.filterMobileBound = 'true';
        openButton.addEventListener('click', function () {
          if (panel.dataset.mobileState === 'open') {
            closeMobileFilterPanel();
          } else {
            openMobileFilterPanel();
          }
        });
      }
    }

    panel.querySelectorAll('[data-filter-close]').forEach(function (button) {
      if (!button.dataset.filterMobileBound) {
        button.dataset.filterMobileBound = 'true';
        button.addEventListener('click', closeMobileFilterPanel);
      }
    });

    if (overlay && !overlay.dataset.filterMobileBound) {
      overlay.dataset.filterMobileBound = 'true';
      overlay.addEventListener('click', closeMobileFilterPanel);
    }

    if (!mobileFilterKeydownBound) {
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          var activePanel = document.querySelector('[data-filter-panel]');
          if (activePanel && activePanel.dataset.mobileState === 'open') {
            closeMobileFilterPanel();
          }
        }
      });
      mobileFilterKeydownBound = true;
    }

    if (!mobileFilterMediaBound) {
      mobileFilterMediaHandler = function (event) {
        var matches = typeof event.matches === 'boolean' ? event.matches : isDesktopView();
        var currentPanel = document.querySelector('[data-filter-panel]');
        var overlayEl = document.querySelector('[data-filter-overlay]');
        if (!currentPanel) {
          return;
        }
        if (matches) {
          currentPanel.classList.remove('hidden');
          currentPanel.setAttribute('aria-hidden', 'false');
          currentPanel.dataset.mobileState = 'closed';
          document.body.classList.remove('filter-panel-open');
          if (overlayEl) {
            overlayEl.classList.add('hidden');
            overlayEl.classList.remove('is-visible');
          }
          previousMobileFilterFocus = null;
        } else if (currentPanel.dataset.mobileState !== 'open') {
          currentPanel.classList.add('hidden');
          currentPanel.setAttribute('aria-hidden', 'true');
        }
      };

      if (desktopMediaQuery && typeof desktopMediaQuery.addEventListener === 'function') {
        desktopMediaQuery.addEventListener('change', mobileFilterMediaHandler);
        mobileFilterMediaBound = true;
      } else if (desktopMediaQuery && typeof desktopMediaQuery.addListener === 'function') {
        desktopMediaQuery.addListener(mobileFilterMediaHandler);
        mobileFilterMediaBound = true;
      } else {
        mobileFilterMediaBound = true;
      }
    }
  }

  function getStoredTripView() {
    try {
      return window.localStorage.getItem(TRIP_VIEW_STORAGE_KEY);
    } catch (error) {
      return null;
    }
  }

  function storeTripView(mode) {
    try {
      window.localStorage.setItem(TRIP_VIEW_STORAGE_KEY, mode);
    } catch (error) {
      // ignore storage failures (private browsing, etc.)
    }
  }

  function applyTripView(mode) {
    var view = mode === 'list' ? 'list' : 'grid';
    var grid = document.querySelector('[data-trip-grid]');
    if (grid) {
      if (view === 'list') {
        grid.classList.add('trip-grid--list');
      } else {
        grid.classList.remove('trip-grid--list');
      }
      grid.setAttribute('data-current-view', view);
    }

    var buttons = document.querySelectorAll('[data-trip-view-toggle] [data-view]');
    Array.prototype.forEach.call(buttons, function (button) {
      var isActive = button.getAttribute('data-view') === view;
      button.classList.toggle('is-active', isActive);
      button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function initTripViewToggle() {
    var grid = document.querySelector('[data-trip-grid]');
    if (!grid) {
      return;
    }

    applyTripView(getStoredTripView());

    var toggle = document.querySelector('[data-trip-view-toggle]');
    if (!toggle || toggle.dataset.viewBound === 'true') {
      return;
    }

    toggle.dataset.viewBound = 'true';
    toggle.addEventListener('click', function (event) {
      var button = event.target.closest('[data-view]');
      if (!button) {
        return;
      }

      var view = button.getAttribute('data-view');
      if (view !== 'grid' && view !== 'list') {
        return;
      }

      storeTripView(view);
      applyTripView(view);
    });
  }

  if (!('fetch' in window) || !('URLSearchParams' in window) || !('FormData' in window)) {
    return;
  }

  function replaceSection(id, doc, options) {
    var current = document.getElementById(id);
    var incoming = doc.getElementById(id);
    if (current && incoming) {
      current.replaceWith(incoming);
    } else if (current && !incoming) {
      current.remove();
    } else if (!current && incoming) {
      var reference = options && options.insertBeforeId ? document.getElementById(options.insertBeforeId) : null;
      if (reference && reference.parentNode) {
        reference.parentNode.insertBefore(incoming, reference);
      } else {
        var main = document.querySelector('main');
        if (main) {
          main.appendChild(incoming);
        }
      }
    }
  }

  function initDestinationNav() {
    var nav = document.getElementById('destination-nav');
    if (!nav || nav.dataset.navScrollBound === 'true') {
      return;
    }

    nav.dataset.navScrollBound = 'true';

    nav.addEventListener('click', function (event) {
      var link = event.target.closest('a[href^="#"]');
      if (!link) {
        return;
      }

      var hash = link.getAttribute('href');
      if (!hash || hash.length < 2) {
        return;
      }

      var targetId = hash.slice(1);
      var section = document.getElementById(targetId);
      if (!section) {
        return;
      }

      event.preventDefault();
      scrollToSection(targetId);

      var baseUrl = window.location.pathname + window.location.search;
      history.replaceState(null, '', baseUrl + '#' + targetId);
    }, { passive: false });
  }

  function submitParams(params, pushHistory) {
    var query = params instanceof URLSearchParams ? params : new URLSearchParams(params);
    var queryString = query.toString();
    var fetchUrl = window.location.pathname + (queryString ? '?' + queryString : '');
    var tripList = document.getElementById('trip-list');
    var activeElement = document.activeElement;
    var restoreSearchFocus = false;
    var searchSelectionStart = null;
    var searchSelectionEnd = null;
    var reopenFilterPanel = false;
    var filterPanel = document.querySelector('[data-filter-panel]');

    if (activeElement && typeof activeElement.matches === 'function' && activeElement.matches('[data-filter-search]')) {
      restoreSearchFocus = true;
      if (typeof activeElement.selectionStart === 'number' && typeof activeElement.selectionEnd === 'number') {
        searchSelectionStart = activeElement.selectionStart;
        searchSelectionEnd = activeElement.selectionEnd;
      }
    }

    if (filterPanel && filterPanel.dataset.mobileState === 'open') {
      reopenFilterPanel = true;
    }

    if (tripList) {
      tripList.setAttribute('aria-busy', 'true');
    }

    fetch(fetchUrl, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin',
    })
      .then(function (response) {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.text();
      })
      .then(function (html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');

        replaceSection('page-top', doc);
        replaceSection('destination-nav', doc, { insertBeforeId: 'destination-summary' });
        replaceSection('destination-summary', doc, { insertBeforeId: 'trip-list' });
        replaceSection('destination-gallery', doc, { insertBeforeId: 'trip-list' });
        replaceSection('trip-list', doc);

        initDestinationNav();

        if (pushHistory) {
          history.pushState(null, '', fetchUrl);
        }

        if (window.initGalleryLightbox) {
          window.initGalleryLightbox();
        }

        initTripFilters();
        initMobileFilters();
        initTripViewToggle();
        initCartToggleButtons();
        if (reopenFilterPanel && !isDesktopView()) {
          openMobileFilterPanel();
        }
      })
      .catch(function (error) {
        console.error('Trip filter update failed:', error);
        window.location.href = fetchUrl;
      })
      .finally(function () {
        var updatedTripList = document.getElementById('trip-list');
        if (updatedTripList) {
          updatedTripList.removeAttribute('aria-busy');
        }
        if (restoreSearchFocus) {
          var searchInput = document.querySelector('[data-filter-search]');
          if (searchInput) {
            searchInput.focus({ preventScroll: true });
            if (typeof searchSelectionStart === 'number' && typeof searchSelectionEnd === 'number' && typeof searchInput.setSelectionRange === 'function') {
              var length = searchInput.value.length;
              var start = Math.min(searchSelectionStart, length);
              var end = Math.min(searchSelectionEnd, length);
              searchInput.setSelectionRange(start, end);
            }
          }
        }
      });
  }

  function initTripFilters() {
    var form = document.querySelector('[data-live-filter]');
    if (!form || form.dataset.liveFilterBound === 'true') {
      return;
    }
    form.dataset.liveFilterBound = 'true';

    var changeDebounceTimer = null;
    var searchDebounceTimer = null;

    form.addEventListener('submit', function (event) {
      event.preventDefault();
      var params = new URLSearchParams(new FormData(form));
      submitParams(params, true);
      if (!isDesktopView()) {
        closeMobileFilterPanel();
      }
    });

    form.addEventListener('change', function (event) {
      if (!(event.target instanceof HTMLInputElement || event.target instanceof HTMLSelectElement)) {
        return;
      }
      clearTimeout(changeDebounceTimer);
      changeDebounceTimer = setTimeout(function () {
        var params = new URLSearchParams(new FormData(form));
        submitParams(params, true);
      }, 200);
    });

    var resetLink = form.querySelector('[data-filter-reset]');
    if (resetLink && !resetLink.dataset.bound) {
      resetLink.dataset.bound = 'true';
      resetLink.addEventListener('click', function (event) {
        event.preventDefault();
        form.reset();
        submitParams(new URLSearchParams(), true);
      });
    }

    var searchInput = form.querySelector('[data-filter-search]');
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(function () {
          var params = new URLSearchParams(new FormData(form));
          submitParams(params, true);
        }, 700);
      });
      searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault();
        }
      });
    }

    if (!hasPopstateListener) {
      window.addEventListener('popstate', function () {
        var params = new URLSearchParams(window.location.search.replace(/^\?/, ''));
        submitParams(params, false);
      });
      hasPopstateListener = true;
    }

  }

  function getClassTokens(button, attr) {
    var value = button.getAttribute(attr);
    if (!value) {
      return [];
    }
    return value.split(/\s+/).filter(function (token) {
      return Boolean(token);
    });
  }

  function setCartButtonState(button, inCart) {
    var added = getClassTokens(button, 'data-cart-class-added');
    var removed = getClassTokens(button, 'data-cart-class-removed');
    var all = added.concat(removed);

    for (var i = 0; i < all.length; i += 1) {
      if (all[i]) {
        button.classList.remove(all[i]);
      }
    }

    if (inCart) {
      for (var j = 0; j < added.length; j += 1) {
        if (added[j]) {
          button.classList.add(added[j]);
        }
      }
      button.textContent = 'Remove from booking list';
      button.setAttribute('data-cart-state', 'added');
      button.setAttribute('aria-expanded', 'false');
    } else {
      for (var k = 0; k < removed.length; k += 1) {
        if (removed[k]) {
          button.classList.add(removed[k]);
        }
      }
      button.textContent = 'Add to booking list';
      button.setAttribute('data-cart-state', 'removed');
      button.setAttribute('aria-expanded', 'false');
    }
  }

  function isoLocalDateString(date) {
    if (!(date instanceof Date) || isNaN(date.getTime())) {
      return '';
    }
    var offset = date.getTimezoneOffset() * 60000;
    var local = new Date(date.getTime() - offset);
    return local.toISOString().slice(0, 10);
  }

  function todayIsoDate() {
    return isoLocalDateString(new Date());
  }

  function clampTravelerCount(value, minValue, maxValue) {
    var parsed = parseInt(value, 10);
    var min = typeof minValue === 'number' && !isNaN(minValue) ? minValue : 1;
    var max = typeof maxValue === 'number' && !isNaN(maxValue) ? maxValue : null;

    if (isNaN(parsed)) {
      parsed = min;
    }
    if (parsed < min) {
      parsed = min;
    }
    if (max !== null && parsed > max) {
      parsed = max;
    }
    return parsed;
  }

  function updateNavCart(data) {
    var badge = document.querySelector('[data-cart-count-badge]');
    if (badge) {
      if (data.cart_count > 0) {
        badge.textContent = data.cart_count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    var label = document.querySelector('[data-cart-label-text]');
    if (label) {
      label.textContent = data.cart_label;
      label.classList.toggle('font-semibold', data.cart_count > 0);
      label.classList.toggle('text-foreground', data.cart_count > 0);
      label.classList.toggle('text-muted-foreground', data.cart_count === 0);
    }

    var panel = document.querySelector('[data-cart-panel]');
    if (panel && typeof data.panel_html === 'string') {
      panel.innerHTML = data.panel_html;
    }

    var navcart = document.querySelector('[data-navcart]');
    var toast = document.querySelector('[data-cart-toast]');
    if (toast) {
      var messageEl = toast.querySelector('[data-cart-toast-message]');
      var iconEl = toast.querySelector('[data-cart-toast-icon]');
      var message = (data.toast_message || '').trim();
      window.clearTimeout(toast._hideTimer);
      if (messageEl) {
        if (message) {
          messageEl.textContent = message;
          if (iconEl) {
            var state = data.in_cart ? 'added' : 'removed';
            iconEl.textContent = data.in_cart ? 'âœ“' : 'â€“';
            toast.dataset.state = state;
          } else {
            toast.dataset.state = data.in_cart ? 'added' : 'removed';
          }
          if (navcart) {
            navcart.dataset.toast = 'show';
          }
          toast._hideTimer = window.setTimeout(function () {
            toast.dataset.state = '';
            if (iconEl) {
              iconEl.textContent = '';
            }
            if (navcart) {
              delete navcart.dataset.toast;
            }
          }, 2400);
        } else {
          toast.dataset.state = '';
          if (iconEl) {
            iconEl.textContent = '';
          }
          messageEl.textContent = '';
          if (navcart) {
            delete navcart.dataset.toast;
          }
        }
      }
    }
  }

  function bindCartToggle(form) {
    if (form.dataset.cartToggleBound === 'true') {
      return;
    }
    form.dataset.cartToggleBound = 'true';

    var toggleButton = form.querySelector('[data-cart-toggle-button]');
    var popover = form.querySelector('[data-quick-add-popover]');
    var container = form.querySelector('[data-quick-add-container]');
    var cancelButton = form.querySelector('[data-quick-add-cancel]');
    var countInput = form.querySelector('[data-quick-add-count]');
    var dateInput = form.querySelector('[data-quick-add-date]');
    var stepButtons = form.querySelectorAll('[data-quick-add-step]');
    var outsideHandler = null;
    var escHandler = null;
    var card = form.closest('.trip-cardi');

    function setAriaExpanded(expanded) {
      if (toggleButton) {
        toggleButton.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      }
    }

    function ensureDateValue() {
      if (!dateInput) {
        return;
      }
      var today = todayIsoDate();
      if (dateInput.min !== today) {
        dateInput.min = today;
      }
      if (!dateInput.value || dateInput.value < today) {
        dateInput.value = today;
      }
    }

    function ensureCountValue() {
      if (!countInput) {
        return;
      }
      var min = parseInt(countInput.getAttribute('min'), 10);
      if (isNaN(min)) {
        min = 1;
      }
      var max = parseInt(countInput.getAttribute('max'), 10);
      if (isNaN(max)) {
        max = null;
      }
      var next = clampTravelerCount(countInput.value, min, max);
      countInput.value = String(next);
    }

    function removeDocumentListeners() {
      if (outsideHandler) {
        document.removeEventListener('mousedown', outsideHandler);
        document.removeEventListener('touchstart', outsideHandler);
        outsideHandler = null;
      }
      if (escHandler) {
        document.removeEventListener('keydown', escHandler);
        escHandler = null;
      }
    }

    function openPopover() {
      if (!popover || popover.dataset.state === 'open') {
        return;
      }
      ensureDateValue();
      ensureCountValue();
      popover.classList.remove('hidden');
      popover.dataset.state = 'open';
      setAriaExpanded(true);
      if (container) {
        container.classList.add('quick-add-open');
      }
      if (card) {
        card.classList.add('quick-add-active');
      }
      outsideHandler = function (event) {
        if (!form.contains(event.target)) {
          closePopover();
        }
      };
      escHandler = function (event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closePopover();
        }
      };
      document.addEventListener('mousedown', outsideHandler);
      document.addEventListener('touchstart', outsideHandler);
      document.addEventListener('keydown', escHandler);
      if (dateInput) {
        window.requestAnimationFrame(function () {
          dateInput.focus();
        });
      }
    }

    function closePopover() {
      if (!popover) {
        setAriaExpanded(false);
        removeDocumentListeners();
        if (card) {
          card.classList.remove('quick-add-active');
        }
        return;
      }
      if (popover.dataset.state !== 'open') {
        setAriaExpanded(false);
        removeDocumentListeners();
        if (card) {
          card.classList.remove('quick-add-active');
        }
        return;
      }
      popover.classList.add('hidden');
      popover.dataset.state = 'closed';
      setAriaExpanded(false);
      removeDocumentListeners();
      if (container) {
        container.classList.remove('quick-add-open');
      }
      if (card) {
        card.classList.remove('quick-add-active');
      }
    }

    if (toggleButton && popover) {
      toggleButton.addEventListener('click', function (event) {
        if (toggleButton.getAttribute('data-cart-state') === 'removed') {
          event.preventDefault();
          if (popover.dataset.state === 'open') {
            closePopover();
          } else {
            openPopover();
          }
        } else {
          closePopover();
        }
      });
    }

    if (cancelButton) {
      cancelButton.addEventListener('click', function () {
        closePopover();
      });
    }

    if (countInput) {
      countInput.addEventListener('change', ensureCountValue);
      countInput.addEventListener('blur', ensureCountValue);
    }

    if (stepButtons.length && countInput) {
      Array.prototype.forEach.call(stepButtons, function (stepButton) {
        stepButton.addEventListener('click', function () {
          var isDown = stepButton.getAttribute('data-quick-add-step') === 'down';
          var min = parseInt(countInput.getAttribute('min'), 10);
          if (isNaN(min)) {
            min = 1;
          }
          var max = parseInt(countInput.getAttribute('max'), 10);
          if (isNaN(max)) {
            max = null;
          }
          var current = clampTravelerCount(countInput.value, min, max);
          var next = current + (isDown ? -1 : 1);
          if (typeof max === 'number' && !isNaN(max)) {
            next = Math.min(next, max);
          }
          next = Math.max(next, min);
          countInput.value = String(next);
        });
      });
    }

    form.addEventListener('submit', function (event) {
      event.preventDefault();
      var submitter = event.submitter;
      var primaryButton = toggleButton || form.querySelector('button[type="submit"]');
      var activeButton = submitter || primaryButton;
      if (!primaryButton) {
        return;
      }

      ensureDateValue();
      ensureCountValue();

      var formData = new FormData(form);
      if (dateInput && dateInput.value) {
        formData.set('date', dateInput.value);
      }
      if (countInput && countInput.value) {
        formData.set('adults', countInput.value);
      }
      if (!formData.get('next')) {
        formData.set('next', window.location.pathname + window.location.search);
      }

      primaryButton.disabled = true;
      primaryButton.setAttribute('aria-busy', 'true');
      if (activeButton && activeButton !== primaryButton) {
        activeButton.disabled = true;
      }

      closePopover();

      fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData,
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Request failed');
          }
          return response.json();
        })
        .then(function (data) {
          setCartButtonState(primaryButton, Boolean(data.in_cart));
          updateNavCart(data);
          if (!data.in_cart) {
            removeDocumentListeners();
          }
        })
        .catch(function () {
          // leave UI unchanged on failure
        })
        .finally(function () {
          primaryButton.disabled = false;
          primaryButton.removeAttribute('aria-busy');
          if (activeButton && activeButton !== primaryButton) {
            activeButton.disabled = false;
          }
        });
    });
  }

  function initCartToggleButtons() {
    var forms = document.querySelectorAll('[data-cart-toggle]');
    if (!forms.length) {
      return;
    }
    Array.prototype.forEach.call(forms, bindCartToggle);
  }

  function initPageEnhancements() {
    initTripFilters();
    initDestinationNav();
    initMobileFilters();
    initTripViewToggle();
    initCartToggleButtons();
  }

  if (document.readyState !== 'loading') {
    initPageEnhancements();
  } else {
    document.addEventListener('DOMContentLoaded', initPageEnhancements, { once: true });
  }
})();
</script>
{% endblock %}
