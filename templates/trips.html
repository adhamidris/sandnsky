{% extends "base.html" %}
{% load static %}

{% block title %}Our Tours & Experiences â€” Nile Dreams{% endblock %}

{% block content %}
{% if destination_hero %}
<section id="page-top" class="relative isolate overflow-hidden bg-black text-white scroll-mt-32">
  {% if destination_hero.image_url %}
  <img src="{{ destination_hero.image_url }}" alt="{{ destination_hero.title }}" class="absolute inset-0 h-full w-full object-cover" />
  {% else %}
  <div class="absolute inset-0 bg-gradient-to-br from-primary/70 via-primary/60 to-black opacity-90"></div>
  {% endif %}
  <div class="absolute inset-0 bg-gradient-to-b from-black/25 via-black/10 to-black/50"></div>
  <div class="relative mx-auto max-w-7xl px-4 pb-28 pt-32 sm:px-6 lg:px-8">
    <div class="max-w-3xl space-y-6">
      <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-white/70">Destination spotlight</span>
      <h1 class="font-serif text-4xl leading-tight sm:text-5xl md:text-6xl">{{ destination_hero.title }}</h1>
      {% if destination_hero.subtitle %}
      <p class="text-base leading-relaxed text-white/80 sm:text-lg">{{ destination_hero.subtitle }}</p>
      {% elif selected_destination and selected_destination.tagline %}
      <p class="text-base leading-relaxed text-white/80 sm:text-lg">{{ selected_destination.tagline }}</p>
      {% endif %}
    </div>
    <div class="mt-12 flex flex-wrap gap-4">
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ trips|length }} itineraries
      </span>
      {% if selected_destination and selected_destination.tagline %}
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.343 7.657 12 12l-4.343-4.343" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.071 4.929A10 10 0 1 0 4.93 19.07 10 10 0 0 0 19.07 4.93Z" />
        </svg>
        {{ selected_destination.tagline }}
      </span>
      {% endif %}
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
        </svg>
        Thoughtfully paced journeys
      </span>
      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-white/80">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        {{ trips|length }} trips available
      </span>
    </div>
  </div>
</section>
{% else %}
<section id="page-top" class="relative isolate overflow-hidden bg-background">
  <div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-accent/10 to-primary/5"></div>
  <div class="relative mx-auto max-w-7xl px-4 pb-28 pt-32 sm:px-6 lg:px-8">
    <div class="max-w-3xl space-y-6 text-center sm:text-left">
      <span class="inline-flex items-center justify-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Our journeys</span>
      <h1 class="font-serif text-4xl leading-tight text-foreground sm:text-5xl md:text-6xl">Our Tours &amp; Experiences</h1>
      <p class="text-base leading-relaxed text-muted-foreground sm:text-lg">Carefully curated journeys to unveil the wonders of Egypt.</p>
      <div class="flex flex-wrap justify-center gap-3 sm:justify-start">
        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Trusted local experts</span>
        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-primary">Small group departures</span>
      </div>
    </div>
  </div>
</section>
{% endif %}

{% if selected_destination %}
<nav id="destination-nav" class="sticky top-16 z-30 border-b border-border/60 bg-background/95 py-3 shadow-sm backdrop-blur lg:py-4" aria-label="Destination navigation">
  <div class="mx-auto flex max-w-7xl flex-col gap-3 px-4 text-sm text-muted-foreground sm:flex-row sm:items-center sm:justify-between sm:px-6 lg:px-8">
    <div class="flex flex-wrap items-center gap-3">
      <a href="#destination-summary" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Overview</a>
      <a href="#trip-list" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Trips</a>
      {% if destination_gallery %}
      <a href="#destination-gallery" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Gallery</a>
      {% endif %}
      <a href="#contact" class="rounded-full px-3 py-1 text-muted-foreground transition-colors hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Speak with us</a>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <div class="text-right text-[11px] uppercase tracking-[0.3em] text-muted-foreground">Speak with our travel team</div>
      <div class="flex items-center gap-2">
        {% for action in contact_actions %}
        {% if action.icon == "whatsapp" %}
        {% with destination_name=selected_destination.name|default:"this destination" %}
        {% with whatsapp_message="Hello Sand & Sky Tours, I would like to know more about the destination "|add:destination_name|add:"." %}
        <a href="https://wa.me/201108741159?text={{ whatsapp_message|urlencode }}" class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-card px-3 py-1.5 text-xs font-semibold text-foreground transition-colors hover:border-primary/40 hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" aria-label="{{ action.aria }}" target="_blank" rel="noopener">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-3.5 w-3.5 text-primary">
            <path d="M12.04 2a9.84 9.84 0 0 0-8.8 14.48L2 22l5.66-1.22A9.83 9.83 0 1 0 12.04 2Zm0 17.73c-1.57 0-3.11-.41-4.46-1.17l-.32-.18-3.36.72.72-3.26-.2-.33A7.86 7.86 0 1 1 12.04 19.73Zm4.38-5.83c-.24-.12-1.43-.7-1.65-.78-.22-.08-.38-.12-.54.12-.16.24-.62.78-.76.94-.14.16-.28.18-.52.06-.24-.12-1-.37-1.9-1.2-.7-.63-1.18-1.4-1.32-1.64-.14-.24-.02-.37.1-.49.1-.09.24-.24.36-.36.12-.12.16-.2.24-.34.08-.14.04-.27-.02-.39-.06-.12-.54-1.31-.74-1.79-.2-.48-.4-.41-.54-.42h-.46c-.16 0-.4.06-.62.3-.22.24-.84.82-.84 2s.86 2.36.98 2.52c.12.16 1.7 2.6 4.12 3.65.58.25 1.03.4 1.38.52.58.18 1.12.16 1.54.1.47-.07 1.43-.58 1.63-1.14.2-.56.2-1.04.14-1.14-.06-.1-.22-.16-.46-.28Z" />
          </svg>
          <span>{{ action.label }}</span>
        </a>
        {% endwith %}
        {% endwith %}
        {% else %}
        <a href="{{ action.href }}" class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-card px-3 py-1.5 text-xs font-semibold text-foreground transition-colors hover:border-primary/40 hover:text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" aria-label="{{ action.aria }}">
          {% if action.icon == "phone" %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path d="M6.5 3h2l1.5 4-2 1c1 2.5 2.9 4.4 5.4 5.4l1-2 4 1.5v2c0 1-1 2-2 2A14 14 0 0 1 4.5 5c0-1 1-2 2-2Z" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          {% elif action.icon == "mail" %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 5h15a1.5 1.5 0 0 1 1.5 1.5v11a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 17.5v-11A1.5 1.5 0 0 1 4.5 5Zm0 0 7.5 6 7.5-6" />
          </svg>
          {% else %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14" />
          </svg>
          {% endif %}
          <span>{{ action.label }}</span>
        </a>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</nav>

<section id="destination-summary" class="scroll-mt-32 bg-secondary/30 px-4 py-20 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-7xl">
    <div class="space-y-8">
      <div class="space-y-5 text-left">
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Why visit {{ selected_destination.name }}</p>
        {% if selected_destination.description %}
        <p class="text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ selected_destination.description }}</p>
        {% else %}
        <p class="text-lg leading-relaxed text-muted-foreground">Discover curated journeys designed to reveal the essence of {{ selected_destination.name }} with expert guides and seamless planning.</p>
        {% endif %}
      </div>
      <div class="space-y-5 text-left">
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Trip style</p>
        {% if destination_hero and destination_hero.subtitle %}
        <p class="text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ destination_hero.subtitle }}</p>
        {% elif selected_destination.tagline %}
        <p class="text-lg leading-relaxed text-muted-foreground whitespace-pre-line">{{ selected_destination.tagline }}</p>
        {% else %}
        <p class="text-lg leading-relaxed text-muted-foreground">Handcrafted journeys that balance iconic highlights with local secrets.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endif %}

<section id="trip-list" class="scroll-mt-32 bg-background px-4 pt-20 pb-24 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-7xl lg:grid lg:grid-cols-[minmax(0,1fr)_280px] lg:gap-12">
    <div id="trip-results" class="space-y-10" aria-live="polite">
      <div class="space-y-4 text-center md:text-left">
        <h2 class="font-serif text-3xl text-foreground sm:text-4xl">
          {% if selected_destination %}
          Trips in {{ selected_destination.name }}
          {% else %}
          Available Tours
          {% endif %}
        </h2>
        <p class="text-base leading-relaxed text-muted-foreground">
          {% if selected_destination %}
          Explore {{ trips|length }} hand-crafted itineraries designed to reveal the heart of {{ selected_destination.name }}. Each journey balances iconic highlights with quieter moments only locals know.
          {% else %}
          Explore {{ trips|length }} journeys crafted by our Egypt specialists. Every itinerary blends essential sights with authentic experiences and seamless service.
          {% endif %}
        </p>
      </div>

      {% if trips %}
      <div class="grid gap-10 sm:grid-cols-2 xl:grid-cols-3">
        {% for trip in trips %}
        <article class="max-h-[520px] group flex h-full flex-col overflow-hidden rounded-md border border-border bg-card shadow-sm transition-colors">
          <div class="relative h-48 overflow-hidden">
            {% if trip.image_url %}
            <img src="{{ trip.image_url }}" alt="{{ trip.title }}" class="h-full w-full object-cover" />
            {% else %}
            <div class="flex h-full items-center justify-center bg-muted text-muted-foreground">
              <span class="text-sm font-semibold uppercase tracking-wide">Image coming soon</span>
            </div>
            {% endif %}
            {% if trip.category %}
            <span class="absolute left-4 top-4 inline-flex items-center rounded-sm bg-primary px-2.5 py-1 text-[11px] font-semibold uppercase tracking-wide text-primary-foreground shadow-sm">
              {{ trip.category }}
            </span>
            {% endif %}
          </div>

          <div class="flex flex-1 flex-col gap-4 p-4">
            <header>
              <h3 class="font-serif text-lg leading-tight text-foreground">{{ trip.title }}</h3>
            </header>

            <div class="mt-auto space-y-4">
              <dl class="trip-card__meta grid grid-cols-1 gap-3 sm:grid-cols-2">
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Duration</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.duration }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Group size</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 17v-1a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v1" />
                    <circle cx="8" cy="7" r="3" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M22 17v-1a4 4 0 0 0-3-3.87" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a3 3 0 0 1-2 2.82" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.group_size }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Location</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10c0 7-7.5 11.5-7.5 11.5S4.5 17 4.5 10a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">{{ trip.location }}</dd>
                </div>
                <div class="trip-card__meta-item flex items-center gap-2">
                  <dt class="sr-only">Starts from</dt>
                  <svg class="trip-card__icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .843-3 1.882C9 10.92 10.343 11.764 12 11.764s3 .843 3 1.882S13.657 15.528 12 15.528s-3-.843-3-1.882" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14" />
                  </svg>
                  <dd class="trip-card__value text-[13px]">
                    <span class="trip-card__prefix">Starts from</span>
                    {{ trip.price }}
                  </dd>
                </div>
              </dl>

              <a href="{% url 'web:trip-detail' trip.slug %}"
                 class="inline-flex w-full items-center justify-center rounded-md bg-primary px-3 py-2 text-xs sm:text-sm font-semibold text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
                View details
              </a>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="mx-auto max-w-3xl rounded-3xl border border-dashed border-border bg-muted/50 p-12 text-center shadow-subtle">
        <h3 class="font-serif text-2xl text-foreground">No trips yet</h3>
        <p class="mt-3 text-base leading-relaxed text-muted-foreground">
          {% if selected_destination %}
          We have not published any trips for {{ selected_destination.name }} yet. Share your travel dreams and our specialists will design a bespoke itinerary.
          {% else %}
          New journeys will be published soon. Check back shortly or reach out to craft a private departure.
          {% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <aside class="mb-12 space-y-6 rounded-2xl border border-border bg-card p-6 shadow-subtle lg:mb-0 lg:self-start">
      <form action="{% url 'web:trips' %}" method="get" class="space-y-6" data-live-filter>
        <div class="space-y-1">
          <h3 class="text-sm font-semibold uppercase tracking-[0.25em] text-muted-foreground">Refine tours</h3>
          <p class="text-xs text-muted-foreground">Use filters to narrow itineraries.</p>
        </div>

        <div class="space-y-2">
          <label for="filter-destination" class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Destination</label>
          <select id="filter-destination" name="destination" class="w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
            <option value="">All destinations</option>
            {% for destination in filter_options.destinations %}
            <option value="{{ destination.slug }}" {% if active_filters.destination == destination.slug %}selected{% endif %}>{{ destination.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="space-y-3">
          <span class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Price (per person)</span>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="filter-price-min" class="text-[11px] uppercase tracking-[0.2em] text-muted-foreground">Min</label>
              <input id="filter-price-min" type="number" name="price_min" placeholder="{{ filter_options.price.min|floatformat:0 }}" value="{% if active_filters.price_min %}{{ active_filters.price_min }}{% endif %}" class="mt-1 w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" min="0" step="50" />
            </div>
            <div>
              <label for="filter-price-max" class="text-[11px] uppercase tracking-[0.2em] text-muted-foreground">Max</label>
              <input id="filter-price-max" type="number" name="price_max" placeholder="{{ filter_options.price.max|floatformat:0 }}" value="{% if active_filters.price_max %}{{ active_filters.price_max }}{% endif %}" class="mt-1 w-full rounded-md border border-border/70 bg-background px-3 py-2 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" min="0" step="50" />
            </div>
          </div>
        </div>

        <fieldset class="space-y-3">
          <legend class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Duration</legend>
          <div class="space-y-2">
            {% for bucket in filter_options.durations %}
            <label class="flex items-center gap-3 text-sm text-muted-foreground">
              <input type="checkbox" name="duration" value="{{ bucket.value }}" class="h-4 w-4 rounded border-border/70 text-primary focus:ring-primary" {% if bucket.value in active_filters.duration_ranges %}checked{% endif %} />
              <span>{{ bucket.label }}</span>
            </label>
            {% endfor %}
          </div>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Group size</legend>
          <div class="space-y-2">
            {% for bucket in filter_options.group_sizes %}
            <label class="flex items-center gap-3 text-sm text-muted-foreground">
              <input type="checkbox" name="group_size" value="{{ bucket.value }}" class="h-4 w-4 rounded border-border/70 text-primary focus:ring-primary" {% if bucket.value in active_filters.group_sizes %}checked{% endif %} />
              <span>{{ bucket.label }}</span>
            </label>
            {% endfor %}
          </div>
        </fieldset>

        {% if filter_options.categories %}
        <fieldset class="space-y-3">
          <legend class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Travel style</legend>
          <div class="space-y-2">
            {% for category in filter_options.categories %}
            <label class="flex items-center gap-3 text-sm text-muted-foreground">
              <input type="checkbox" name="category" value="{{ category.slug }}" class="h-4 w-4 rounded border-border/70 text-primary focus:ring-primary" {% if category.slug in active_filters.categories %}checked{% endif %} />
              <span>{{ category.name }}</span>
            </label>
            {% endfor %}
          </div>
        </fieldset>
        {% endif %}

        <div class="flex flex-wrap items-center gap-3">
          <button type="submit" class="inline-flex items-center justify-center rounded-full bg-primary px-5 py-2 text-sm font-semibold text-primary-foreground shadow-subtle transition-colors hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Apply filters</button>
          <a href="{% url 'web:trips' %}" class="text-sm font-semibold text-muted-foreground transition-colors hover:text-primary" data-filter-reset>Reset</a>
        </div>
      </form>
    </aside>
  </div>
</section>
{% if destination_gallery %}
<section id="destination-gallery" class="scroll-mt-32 bg-secondary/30 px-4 py-20 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-7xl space-y-8">
    <div class="space-y-2 text-left">
      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">Gallery</p>
      <div class="flex flex-wrap items-end justify-between gap-3">
        <h2 class="font-serif text-3xl text-foreground">Scenes from {{ selected_destination.name }}</h2>
        <span class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">{{ destination_gallery|length }} image{% if destination_gallery|length != 1 %}s{% endif %}</span>
      </div>
      <p class="text-sm leading-relaxed text-muted-foreground">A curated glimpse of the landscapes, textures, and moments waiting for you.</p>
    </div>
    <div class="gallery-grid grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3" data-gallery>
      {% for item in destination_gallery %}
      <figure class="gallery-card group relative overflow-hidden rounded-2xl border border-border/60 bg-card/80 shadow-subtle {% if item.is_landscape %}gallery-card--landscape{% endif %}" data-gallery-item data-gallery-full="{{ item.image_url }}" data-gallery-caption="{{ item.caption|default:''|escape }}">
        <button type="button" class="gallery-card__button" data-gallery-trigger aria-label="View larger image {{ forloop.counter }}">
          <img src="{{ item.image_url }}" alt="{{ selected_destination.name }} gallery image {{ forloop.counter }}" class="gallery-card__image transition-transform duration-500 group-hover:scale-110" loading="lazy" />
          {% if item.caption %}
          <span class="gallery-card__scrim" aria-hidden="true"></span>
          <span class="gallery-card__caption">{{ item.caption }}</span>
          {% endif %}
        </button>
        {% if item.caption %}
        <figcaption class="sr-only">{{ item.caption }}</figcaption>
        {% endif %}
      </figure>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}
{% if destination_gallery %}
<div class="gallery-lightbox" data-gallery-overlay hidden>
  <div class="gallery-lightbox__backdrop" data-gallery-close></div>
  <div class="gallery-lightbox__dialog" role="dialog" aria-modal="true" aria-label="Destination gallery viewer" tabindex="-1">
    <button type="button" class="gallery-lightbox__close" data-gallery-close aria-label="Close gallery">
      <span aria-hidden="true">&times;</span>
    </button>
    <figure class="gallery-lightbox__figure">
      <div class="gallery-lightbox__media">
        <img src="" alt="Expanded gallery image" class="gallery-lightbox__image" data-gallery-active-image />
        <div class="gallery-lightbox__controls">
          <button type="button" class="gallery-lightbox__nav" data-gallery-prev aria-label="View previous image">
            <span aria-hidden="true">&#8592;</span>
          </button>
          <button type="button" class="gallery-lightbox__nav" data-gallery-next aria-label="View next image">
            <span aria-hidden="true">&#8594;</span>
          </button>
        </div>
      </div>
      <figcaption class="gallery-lightbox__caption" data-gallery-active-caption></figcaption>
    </figure>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ block.super }}
{% if destination_gallery %}
<script src="{% static 'js/gallery-lightbox.js' %}"></script>
{% endif %}
<script>
(function () {
  var hasPopstateListener = false;
  var BASE_SCROLL_OFFSET = 24;

  function calculateScrollOffset(target) {
    var offset = BASE_SCROLL_OFFSET;
    var primaryNav = document.querySelector('nav.fixed');
    if (primaryNav) {
      offset += primaryNav.getBoundingClientRect().height;
    }

    var destinationNav = document.getElementById('destination-nav');
    if (destinationNav) {
      offset += destinationNav.getBoundingClientRect().height;
    }

    if (target && target.dataset && target.dataset.scrollOffset) {
      var customOffset = parseInt(target.dataset.scrollOffset, 10);
      if (!Number.isNaN(customOffset)) {
        offset += customOffset;
      }
    }

    return offset;
  }

  function scrollToSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (!section) {
      return false;
    }
    window.requestAnimationFrame(function () {
      var top = window.pageYOffset + section.getBoundingClientRect().top - calculateScrollOffset(section);
      window.scrollTo({ top: Math.max(top, 0), behavior: 'smooth' });
    });
    return true;
  }

  function smoothScrollToResults() {
    scrollToSection('trip-list');
  }

  if (!('fetch' in window) || !('URLSearchParams' in window) || !('FormData' in window)) {
    return;
  }

  function replaceSection(id, doc, options) {
    var current = document.getElementById(id);
    var incoming = doc.getElementById(id);
    if (current && incoming) {
      current.replaceWith(incoming);
    } else if (current && !incoming) {
      current.remove();
    } else if (!current && incoming) {
      var reference = options && options.insertBeforeId ? document.getElementById(options.insertBeforeId) : null;
      if (reference && reference.parentNode) {
        reference.parentNode.insertBefore(incoming, reference);
      } else {
        var main = document.querySelector('main');
        if (main) {
          main.appendChild(incoming);
        }
      }
    }
  }

  function initDestinationNav() {
    var nav = document.getElementById('destination-nav');
    if (!nav || nav.dataset.navScrollBound === 'true') {
      return;
    }

    nav.dataset.navScrollBound = 'true';

    nav.addEventListener('click', function (event) {
      var link = event.target.closest('a[href^="#"]');
      if (!link) {
        return;
      }

      var hash = link.getAttribute('href');
      if (!hash || hash.length < 2) {
        return;
      }

      var targetId = hash.slice(1);
      var section = document.getElementById(targetId);
      if (!section) {
        return;
      }

      event.preventDefault();
      scrollToSection(targetId);

      var baseUrl = window.location.pathname + window.location.search;
      history.replaceState(null, '', baseUrl + '#' + targetId);
    }, { passive: false });
  }

  function submitParams(params, pushHistory) {
    var query = params instanceof URLSearchParams ? params : new URLSearchParams(params);
    var queryString = query.toString();
    var fetchUrl = window.location.pathname + (queryString ? '?' + queryString : '');
    var tripList = document.getElementById('trip-list');
    if (tripList) {
      tripList.setAttribute('aria-busy', 'true');
    }

    fetch(fetchUrl, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin',
    })
      .then(function (response) {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.text();
      })
      .then(function (html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');

        replaceSection('page-top', doc);
        replaceSection('destination-nav', doc, { insertBeforeId: 'destination-summary' });
        replaceSection('destination-summary', doc, { insertBeforeId: 'trip-list' });
        replaceSection('destination-gallery', doc, { insertBeforeId: 'trip-list' });
        replaceSection('trip-list', doc);

        initDestinationNav();

        if (pushHistory) {
          history.pushState(null, '', fetchUrl);
        }

        if (window.initGalleryLightbox) {
          window.initGalleryLightbox();
        }

        initTripFilters();
      })
      .catch(function (error) {
        console.error('Trip filter update failed:', error);
        window.location.href = fetchUrl;
      })
      .finally(function () {
        var updatedTripList = document.getElementById('trip-list');
        if (updatedTripList) {
          updatedTripList.removeAttribute('aria-busy');
        }
      });
  }

  function initTripFilters() {
    var form = document.querySelector('[data-live-filter]');
    if (!form || form.dataset.liveFilterBound === 'true') {
      return;
    }
    form.dataset.liveFilterBound = 'true';

    var debounceTimer = null;

    form.addEventListener('submit', function (event) {
      event.preventDefault();
      var params = new URLSearchParams(new FormData(form));
      submitParams(params, true);
    });

    form.addEventListener('change', function (event) {
      if (!(event.target instanceof HTMLInputElement || event.target instanceof HTMLSelectElement)) {
        return;
      }
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function () {
        var params = new URLSearchParams(new FormData(form));
        submitParams(params, true);
      }, 200);
    });

    var resetLink = form.querySelector('[data-filter-reset]');
    if (resetLink && !resetLink.dataset.bound) {
      resetLink.dataset.bound = 'true';
      resetLink.addEventListener('click', function (event) {
        event.preventDefault();
        form.reset();
        submitParams(new URLSearchParams(), true);
      });
    }

    if (!hasPopstateListener) {
      window.addEventListener('popstate', function () {
        var params = new URLSearchParams(window.location.search.replace(/^\?/, ''));
        submitParams(params, false);
      });
      hasPopstateListener = true;
    }

  }

  function initPageEnhancements() {
    initTripFilters();
    initDestinationNav();
  }

  if (document.readyState !== 'loading') {
    initPageEnhancements();
  } else {
    document.addEventListener('DOMContentLoaded', initPageEnhancements, { once: true });
  }
})();
</script>
{% endblock %}
