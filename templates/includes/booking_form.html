<form
  action=""
  method="post"
  class="space-y-6"
  id="booking-form"
  data-module="booking-form"
  data-base-price="{{ pricing.adult_price|floatformat:'-2' }}"
  data-adult-price="{{ pricing.adult_price|floatformat:'-2' }}"
  data-child-price="{{ pricing.child_price|floatformat:'-2' }}"
  data-selected-option="{{ pricing.selected_option_id|default_if_none:'' }}"
  data-currency-symbol="{{ pricing.currency_symbol }}"
>
  {% csrf_token %}
  {% if form.non_field_errors %}
  <div class="rounded-md border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-700">
    {{ form.non_field_errors|striptags }}
  </div>
  {% endif %}

  <div class="space-y-3" data-contact-section>
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-foreground">1. Dates</h3>
      <span class="text-xs text-muted-foreground">Confirm availability</span>
    </div>
    <div class="space-y-2">
      <label class="sr-only" for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
      {{ form.date }}
      {% if form.date.errors %}
      <p class="text-sm text-red-600">{{ form.date.errors|striptags }}</p>
      {% else %}
      <p class="text-xs text-muted-foreground">Choose your preferred travel date.</p>
      {% endif %}
    </div>
  </div>

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-foreground">2. Travelers</h3>
      <span class="text-xs text-muted-foreground">Adjust party size</span>
    </div>
    <div class="space-y-3">
      <div class="flex items-center justify-between rounded-lg border border-border bg-background px-3 py-2">
        <div>
          <p class="text-sm font-medium">Adults</p>
          <p class="text-xs text-muted-foreground">
            {% if trip.minimum_age %}{{ trip.minimum_age }}+ years{% else %}12+ years{% endif %}
            <span data-booking-adult-price-wrapper class="{% if not pricing.adult_price_display %}hidden{% endif %}">
              · <span data-booking-adult-price>{{ pricing.adult_price_display }}</span>
            </span>
          </p>
        </div>
        <div class="flex items-center gap-2" data-counter>
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-dec aria-label="Decrease adults">−</button>
          {{ form.adults }}
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-inc aria-label="Increase adults">+</button>
        </div>
      </div>
      {% if trip.allow_children %}
      <div class="flex items-center justify-between rounded-lg border border-border bg-background px-3 py-2">
        <div>
          <p class="text-sm font-medium">Children</p>
          <p class="text-xs text-muted-foreground">
            3–6 years
            <span data-booking-child-price-wrapper class="{% if not pricing.has_child_price %}hidden{% endif %}">
              · <span data-booking-child-price>{{ pricing.child_price_display }}</span>
            </span>
          </p>
        </div>
        <div class="flex items-center gap-2" data-counter>
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-dec aria-label="Decrease children">−</button>
          {{ form.children }}
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-inc aria-label="Increase children">+</button>
        </div>
      </div>
      {% else %}
      <div class="rounded-lg border border-border bg-background px-3 py-3 text-xs text-muted-foreground">
        This experience is adults-only. Guests must be {% if trip.minimum_age %}{{ trip.minimum_age }}+{% else %}18+{% endif %} on jump day.
      </div>
      {% endif %}

      {% if trip.allow_infants %}
      <div class="flex items-center justify-between rounded-lg border border-border bg-background px-3 py-2">
        <div>
          <p class="text-sm font-medium">Infants</p>
          <p class="text-xs text-muted-foreground">
            <span class="inline-flex items-center gap-2">
              <span>0–2 years</span>
              <span class="inline-flex items-center rounded-full border border-primary/30 bg-primary/5 px-1.5 py-[2px] text-[10px] font-semibold uppercase tracking-[0.18em] text-primary">Free</span>
            </span>
          </p>
        </div>
        <div class="flex items-center gap-2" data-counter>
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-dec aria-label="Decrease infants">−</button>
          {{ form.infants }}
          <button type="button" class="h-8 w-8 rounded-full border border-border text-lg" data-counter-inc aria-label="Increase infants">+</button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  {% if trip.booking_options %}
  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-foreground">3. Experiences</h3>
      <span class="text-xs text-muted-foreground">Choose your preferred package</span>
    </div>
    <div class="space-y-2" data-booking-option-list>
      {% for option in trip.booking_options %}
      <label
        class="flex items-start justify-between gap-4 rounded-lg border border-border bg-background px-4 py-3 transition {% if option.selected %}ring-1 ring-primary/40{% endif %}"
        data-booking-option
        data-option-id="{{ option.id }}"
        data-option-label="{{ option.label }}"
        data-selected="{{ option.selected|yesno:'true,false' }}"
      >
        <span class="flex items-start gap-3">
          <input
            type="radio"
            name="option"
            value="{{ option.id }}"
            {% if option.selected %}checked{% endif %}
            class="mt-1 h-4 w-4 border-border text-primary focus:ring-primary"
            data-option-price="{{ option.price|floatformat:'-2' }}"
            data-option-child-price="{{ option.child_price|floatformat:'-2' }}"
          />
          <span class="text-sm text-foreground">
            <span class="font-medium">{{ option.label }}</span>
            {% if option.has_child_override %}
            <span class="mt-1 block text-xs text-muted-foreground">Children: {{ option.child_price_display }}</span>
            {% endif %}
          </span>
        </span>
        <span class="text-sm font-semibold text-foreground">{{ option.price_display }}</span>
      </label>
      {% endfor %}
    </div>
    {% if form.option.errors %}
    <p class="text-sm text-red-600">{{ form.option.errors|striptags }}</p>
    {% endif %}
  </div>
  {% endif %}

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-foreground">{% if trip.booking_options %}4{% else %}3{% endif %}. Extras</h3>
      <span class="text-xs text-muted-foreground">Optional add-ons</span>
    </div>
    <div class="space-y-2">
      {% if trip.extras %}
      {% for extra in trip.extras %}
      <label class="flex items-start justify-between gap-4 rounded-lg border border-border bg-background px-4 py-3">
        <span class="flex items-start gap-3">
          <input type="checkbox" name="extras" value="{{ extra.id }}" {% if extra.selected %}checked{% endif %} class="mt-1 h-4 w-4 rounded border-border" data-extra-price="{{ extra.price }}" />
          <span class="text-sm text-foreground">
            <span class="font-medium">{{ extra.label }}</span>
          </span>
        </span>
        <span class="text-sm font-semibold text-foreground">{{ extra.price_display }}</span>
      </label>
      {% endfor %}
      {% else %}
      <p class="text-xs text-muted-foreground">No add-ons available for this experience.</p>
      {% endif %}
    </div>
    {% if form.extras.errors %}
    <p class="text-sm text-red-600">{{ form.extras.errors|striptags }}</p>
    {% endif %}
  </div>

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-foreground">4. Contact details</h3>
      <span class="text-xs text-muted-foreground">We’ll get back within 24h</span>
    </div>
    <div class="space-y-4">
      <div class="space-y-2">
        <label for="{{ form.name.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground">{{ form.name.label }}</label>
        {{ form.name }}
        {% if form.name.errors %}
        <p class="text-sm text-red-600">{{ form.name.errors|striptags }}</p>
        {% endif %}
      </div>

      <div class="grid gap-4 sm:grid-cols-2">
        <div class="space-y-2">
          <label for="{{ form.email.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground">{{ form.email.label }}</label>
          {{ form.email }}
          {% if form.email.errors %}
          <p class="text-sm text-red-600">{{ form.email.errors|striptags }}</p>
          {% endif %}
        </div>
        <div class="space-y-2">
          <label for="{{ form.phone.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% if form.phone.errors %}
          <p class="text-sm text-red-600">{{ form.phone.errors|striptags }}</p>
          {% endif %}
        </div>
      </div>

      <div class="space-y-2">
        <label for="{{ form.message.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground">{{ form.message.label }}</label>
        {{ form.message }}
        {% if form.message.errors %}
        <p class="text-sm text-red-600">{{ form.message.errors|striptags }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div data-booking-submit class="space-y-3">
    <div class="space-y-2">
      <button type="submit" name="action" value="book_only" class="inline-flex w-full items-center justify-center rounded-lg bg-primary px-5 py-3 text-sm font-semibold text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        {% if booking_cart_count %}
        <span class="flex flex-col items-center leading-tight text-center">
          <span class="review-confirm">Review &amp; confirm</span>
          {% with remaining=trip_cart_other_count %}
          <span class="review-confirm mt-0.5 text-[11px] font-medium text-primary-foreground/80">
            For this trip{% if remaining %} and {{ remaining }} more trip{{ remaining|pluralize }}{% endif %} on your booking list.
          </span>
          {% endwith %}
        </span>
        {% else %}
        Book this trip only
        {% endif %}
      </button>
      <button type="submit" name="action" value="add_to_list" formnovalidate class="inline-flex w-full items-center justify-center rounded-lg border border-primary px-5 py-3 text-sm font-semibold text-primary transition-colors hover:bg-primary/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        Add to booking list &amp; add more trips
      </button>
    </div>
    {% if booking_cart_count %}
    <p class="text-center text-xs text-muted-foreground">{{ booking_cart_count }} trip{{ booking_cart_count|pluralize }} waiting in your booking list.</p>
    {% endif %}
    <p class="text-center text-xs text-muted-foreground">
      Prefer to talk to someone? <a href="tel:+201234567890" class="font-semibold text-primary hover:text-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Call us</a> or <a href="mailto:info@niledreams.com" class="font-semibold text-primary hover:text-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">send an inquiry</a>.
    </p>
  </div>
</form>
