{% load static %}
{% if trip_picks_section.toggles %}
<section id="trip-picks" class="trip-picks" aria-labelledby="trip-picks-title" data-trip-picks>
  <div class="wrap">
    <div class="trip-picks__head">
      <div class="trip-picks__intro">
        {% if trip_picks_section.eyebrow %}
        <span class="trip-picks__eyebrow">{{ trip_picks_section.eyebrow }}</span>
        {% endif %}
        <h2 id="trip-picks-title">{{ trip_picks_section.title }}</h2>
      </div>
      <div class="trip-picks__toggle-group" role="tablist" aria-label="Trip collections">
        {% for toggle in trip_picks_section.toggles %}
        {% with button_id="trip-toggle-"|add:toggle.slug panel_id="trip-panel-"|add:toggle.slug %}
        <button
          type="button"
          id="{{ button_id }}"
          class="trip-picks__toggle{% if forloop.first %} is-active{% endif %}"
          role="tab"
          aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
          aria-controls="{{ panel_id }}"
          data-trip-toggle="{{ toggle.slug }}"
        >
          {{ toggle.label }}
        </button>
        {% endwith %}
        {% endfor %}
      </div>
    </div>

    <div class="trip-picks__panels">
      {% for toggle in trip_picks_section.toggles %}
      {% with panel_id="trip-panel-"|add:toggle.slug %}
      <div
        id="{{ panel_id }}"
        class="trip-picks__panel{% if not forloop.first %} is-hidden{% endif %}"
        role="tabpanel"
        aria-labelledby="trip-toggle-{{ toggle.slug }}"
        {% if not forloop.first %}hidden{% endif %}
        data-trip-panel="{{ toggle.slug }}"
      >
        {% if toggle.cards %}
        <div class="trip-picks__carousel" data-trip-carousel>
          <button class="trip-picks__arrow" type="button" aria-label="Previous trips" data-trip-arrow="prev">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="m14.5 18-5-6 5-6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="trip-picks__viewport" data-trip-viewport>
            <div class="trip-picks__track" data-trip-track>
              {% for trip in toggle.cards %}
              <article class="trip-picks__card{% if trip.is_package_trip %} trip-picks__card--package{% endif %}">
                <a href="{% url 'web:trip-detail' trip.slug %}" class="trip-picks__link">
                  <div class="trip-picks__media">
                    <!-- {% if trip.languages %}
                    <ul class="trip-picks__languages" aria-label="Available languages">
                      {% for language in trip.languages %}
                      <li class="trip-picks__language-chip">{{ language }}</li>
                      {% endfor %}
                    </ul>
                    {% endif %} -->
                    <div class="trip-picks__media-inner">
                      {% if trip.image_url %}
                      <img src="{{ trip.image_url }}" alt="{{ trip.title }}" loading="lazy" class="trip-picks__image" />
                      {% else %}
                      <div class="trip-picks__image trip-picks__image--fallback">
                        <span>Image coming soon</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="trip-picks__body">
                    {% if trip.is_package_trip and trip.route_steps %}
                    <div class="trip-picks__package-banner" aria-label="Trip route">
                      <span class="trip-picks__package-eyebrow">Signature route</span>
                      <div class="trip-picks__package-route">
                        {% for stop in trip.route_steps %}
                        <span class="trip-picks__package-stop">{{ stop }}</span>
                        <!-- {% if not forloop.last %}
                        <span class="trip-picks__package-separator" aria-hidden="true">→</span>
                        {% endif %} -->
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                    <!-- {% if trip.category %}
                    <span class="trip-picks__badge">{{ trip.category }}</span>
                    {% endif %} -->
                    <h3 class="trip-picks__title">{{ trip.title }}</h3>
                    <!-- {% if trip.is_package_trip and trip.description %}
                    <p class="trip-picks__description trip-picks__description--package">{{ trip.description }}</p>
                    {% endif %} -->
                    <div class="trip-picks__meta">
                      <span>{{ trip.duration }}</span>
                      <!-- <span>{{ trip.group_size }}</span> -->
                      <span>{{ trip.location }}</span>
                      <span class="trip-picks__price">
                        <span class="block text-[11px] text-muted-foreground">Adult: {{ trip.price }}</span>
                        {% if trip.has_child_price and trip.child_price %}
                        <span class="block text-[11px] text-muted-foreground">Children: {{ trip.child_price }}</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </a>
                <div class="trip-picks__actions">
                  <a
                    href="{% url 'web:trip-detail' trip.slug %}"
                    class="trip-picks__action-btn trip-picks__action-btn--primary"
                  >
                    View details
                  </a>
                  <form
                    method="post"
                    action="{% url 'web:booking-cart-quick-add' trip.slug %}"
                    class="trip-picks__action-form"
                    data-cart-toggle
                  >
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    {% with date_id="picks-quick-add-date-"|add:trip.slug adults_id="picks-quick-add-adults-"|add:trip.slug children_id="picks-quick-add-children-"|add:trip.slug infants_id="picks-quick-add-infants-"|add:trip.slug %}
                    <div class="trip-picks__quick-add" data-quick-add-container>
                      <button
                        type="submit"
                        class="trip-picks__action-btn {% if trip.in_cart %}trip-picks__action-btn--remove{% else %}trip-picks__action-btn--secondary{% endif %}"
                        data-cart-toggle-button
                        data-trip-id="{{ trip.id }}"
                        data-cart-label-added="Remove from booking list"
                        data-cart-label-removed="Add to booking list"
                        data-cart-state="{% if trip.in_cart %}added{% else %}removed{% endif %}"
                        data-cart-class-added="trip-picks__action-btn--remove"
                        data-cart-class-removed="trip-picks__action-btn--secondary"
                        aria-haspopup="dialog"
                        aria-expanded="false"
                      >
                        {% if trip.in_cart %}
                        Remove from booking list
                        {% else %}
                        Add to booking list
                        {% endif %}
                      </button>
                      <div
                        class="quick-add-popover trip-picks__popover hidden"
                        data-quick-add-popover
                        role="dialog"
                        aria-label="Add {{ trip.title }} to booking list"
                        aria-modal="false"
                        data-state="closed"
                      >
                        <div class="trip-picks__popover-body">
                          <div class="trip-picks__popover-field">
                            <label for="{{ date_id }}">Travel date</label>
                            <input
                              id="{{ date_id }}"
                              type="date"
                              name="date"
                              data-quick-add-date
                            />
                          </div>
                          <div class="trip-picks__popover-field">
                            <label for="{{ adults_id }}">Adults</label>
                            <div class="trip-picks__popover-counter">
                              <button type="button" data-quick-add-step="down" data-quick-add-target="adults" aria-label="Decrease adults">-</button>
                              <input
                                id="{{ adults_id }}"
                                type="number"
                                name="adults"
                                min="1"
                                max="16"
                                value="1"
                                data-quick-add-input="adults"
                              />
                              <button type="button" data-quick-add-step="up" data-quick-add-target="adults" aria-label="Increase adults">+</button>
                            </div>
                          </div>
                          <div class="trip-picks__popover-field">
                            <label for="{{ children_id }}">Children</label>
                            <div class="trip-picks__popover-counter">
                              <button type="button" data-quick-add-step="down" data-quick-add-target="children" aria-label="Decrease children">-</button>
                              <input
                                id="{{ children_id }}"
                                type="number"
                                name="children"
                                min="0"
                                max="12"
                                value="0"
                                data-quick-add-input="children"
                              />
                              <button type="button" data-quick-add-step="up" data-quick-add-target="children" aria-label="Increase children">+</button>
                            </div>
                          </div>
                          <div class="trip-picks__popover-field">
                            <label for="{{ infants_id }}">Infants</label>
                            <div class="trip-picks__popover-counter">
                              <button type="button" data-quick-add-step="down" data-quick-add-target="infants" aria-label="Decrease infants">-</button>
                              <input
                                id="{{ infants_id }}"
                                type="number"
                                name="infants"
                                min="0"
                                max="6"
                                value="0"
                                data-quick-add-input="infants"
                              />
                              <button type="button" data-quick-add-step="up" data-quick-add-target="infants" aria-label="Increase infants">+</button>
                            </div>
                          </div>
                          <div class="trip-picks__popover-actions">
                            <button type="button" data-quick-add-cancel>Cancel</button>
                            <button type="submit" data-quick-add-confirm>Add trip</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endwith %}
                  </form>
                </div>
              </article>
              {% endfor %}
            </div>
          </div>
          <button class="trip-picks__arrow" type="button" aria-label="Next trips" data-trip-arrow="next">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="m9.5 6 5 6-5 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <a href="{{ trip_picks_section.view_all_href }}" class="trip-picks__cta">View all tours</a>
        {% else %}
        <div class="trip-picks__empty">
          <p>No trips available in this collection yet. Check back soon.</p>
          <a href="{{ trip_picks_section.view_all_href }}" class="trip-picks__cta">View all tours</a>
        </div>
        {% endif %}
      </div>
      {% endwith %}
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{% block script %}
<script>
(() => {
  const section = document.querySelector('[data-trip-picks]');
  if (!section) return;

  const toggles = Array.from(section.querySelectorAll('[data-trip-toggle]'));
  const panels = Array.from(section.querySelectorAll('[data-trip-panel]'));

  const isoLocalDateString = (date) => {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
      return '';
    }
    const offset = date.getTimezoneOffset() * 60000;
    const local = new Date(date.getTime() - offset);
    return local.toISOString().slice(0, 10);
  };

  const todayIsoDate = () => isoLocalDateString(new Date());

  const clampTravelerCount = (value, minValue, maxValue) => {
    const parsed = parseInt(value, 10);
    const min = typeof minValue === 'number' && !Number.isNaN(minValue) ? minValue : 1;
    const max =
      typeof maxValue === 'number' && !Number.isNaN(maxValue) ? maxValue : null;
    let next = Number.isNaN(parsed) ? min : parsed;
    if (next < min) {
      next = min;
    }
    if (typeof max === 'number' && !Number.isNaN(max) && next > max) {
      next = max;
    }
    return next;
  };

  const getClassTokens = (button, attr) => {
    const value = button.getAttribute(attr);
    if (!value) {
      return [];
    }
    return value
      .split(/\s+/)
      .map((token) => token.trim())
      .filter(Boolean);
  };

  const setCartButtonState = (button, inCart) => {
    const added = getClassTokens(button, 'data-cart-class-added');
    const removed = getClassTokens(button, 'data-cart-class-removed');
    const allTokens = [...added, ...removed];

    allTokens.forEach((token) => {
      if (token) {
        button.classList.remove(token);
      }
    });

    const targetTokens = inCart ? added : removed;
    targetTokens.forEach((token) => {
      if (token) {
        button.classList.add(token);
      }
    });

    const addedLabel = button.getAttribute('data-cart-label-added') || 'Remove from booking list';
    const removedLabel = button.getAttribute('data-cart-label-removed') || 'Add to booking list';
    button.setAttribute('data-cart-state', inCart ? 'added' : 'removed');
    button.setAttribute('aria-expanded', 'false');
    button.textContent = inCart ? addedLabel : removedLabel;
  };

  const syncCartButtons = (payload) => {
    if (!payload) return;
    const buttons = Array.from(document.querySelectorAll('[data-cart-toggle-button][data-trip-id]'));
    if (!buttons.length) return;

    const tripIds = [];
    if (payload.cart_summary && Array.isArray(payload.cart_summary.entries)) {
      payload.cart_summary.entries.forEach((entry) => {
        if (!entry) return;
        const parsed = parseInt(entry.trip_id, 10);
        if (!Number.isNaN(parsed) && !tripIds.includes(parsed)) {
          tripIds.push(parsed);
        }
      });
    }
    const hasSummary = tripIds.length > 0;
    const targetTripId = payload.trip_id !== undefined ? parseInt(payload.trip_id, 10) : NaN;

    buttons.forEach((button) => {
      const attr = button.getAttribute('data-trip-id');
      if (!attr) return;
      const tripId = parseInt(attr, 10);
      if (Number.isNaN(tripId)) return;
      let inCart = false;
      if (hasSummary) {
        inCart = tripIds.includes(tripId);
      } else if (!Number.isNaN(targetTripId) && tripId === targetTripId) {
        inCart = !!payload.in_cart;
      }
      setCartButtonState(button, inCart);
    });
  };

  const updateNavCart = (data) => {
    if (!data || typeof data !== 'object') {
      return;
    }
    const badge = document.querySelector('[data-cart-count-badge]');
    if (badge) {
      badge.textContent = String(data.cart_count);
      badge.classList.remove('hidden');
    }

    const label = document.querySelector('[data-cart-label-text]');
    if (label && typeof data.cart_label === 'string') {
      label.textContent = data.cart_label;
      label.classList.toggle('font-semibold', data.cart_count > 0);
      label.classList.toggle('text-foreground', data.cart_count > 0);
      label.classList.toggle('text-muted-foreground', data.cart_count === 0);
    }

    const panel = document.querySelector('[data-cart-panel]');
    if (panel && typeof data.panel_html === 'string') {
      panel.innerHTML = data.panel_html;
    }

    const navcart = document.querySelector('[data-navcart]');
    const toast = document.querySelector('[data-cart-toast]');
    if (navcart && toast) {
      const messageEl = toast.querySelector('[data-cart-toast-message]');
      const iconEl = toast.querySelector('[data-cart-toast-icon]');
      const message = (data.toast_message || '').trim();
      window.clearTimeout(toast._hideTimer);
      if (messageEl && message) {
        messageEl.textContent = message;
        if (iconEl) {
          iconEl.textContent = data.in_cart ? '✓' : '-';
        }
        toast.dataset.state = data.in_cart ? 'added' : 'removed';
        navcart.dataset.toast = 'show';
        toast._hideTimer = window.setTimeout(() => {
          toast.dataset.state = '';
          if (iconEl) {
            iconEl.textContent = '';
          }
          delete navcart.dataset.toast;
        }, 2400);
      } else {
        toast.dataset.state = '';
        if (iconEl) {
          iconEl.textContent = '';
        }
        delete navcart.dataset.toast;
      }
    }
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('booking:cart-update', { detail: data }));
    }
  };

  const bindQuickAddForm = (form) => {
    if (!form || form.dataset.tripPicksBound === 'true') {
      return;
    }
    form.dataset.tripPicksBound = 'true';

    const toggleButton = form.querySelector('[data-cart-toggle-button]');
    const container = form.querySelector('[data-quick-add-container]');
    const popover = form.querySelector('[data-quick-add-popover]');
    const cancelButton = form.querySelector('[data-quick-add-cancel]');
    const travelerInputs = {
      adults: form.querySelector('[data-quick-add-input="adults"]'),
      children: form.querySelector('[data-quick-add-input="children"]'),
      infants: form.querySelector('[data-quick-add-input="infants"]'),
    };
    const dateInput = form.querySelector('[data-quick-add-date]');
    const stepButtons = Array.from(form.querySelectorAll('[data-quick-add-step]'));
    const card = form.closest('.trip-picks__card');

    let outsideHandler = null;
    let escHandler = null;

    const setExpanded = (expanded) => {
      if (toggleButton) {
        toggleButton.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      }
    };

    const ensureDateValue = () => {
      if (!dateInput) return;
      const today = todayIsoDate();
      if (dateInput.min !== today) {
        dateInput.min = today;
      }
      if (!dateInput.value || dateInput.value < today) {
        dateInput.value = today;
      }
    };

    const ensureTravelerValue = (input, fallback, minimum) => {
      if (!input) return null;
      const minAttr = parseInt(input.getAttribute('min'), 10);
      const maxAttr = parseInt(input.getAttribute('max'), 10);
      const min = Number.isNaN(minAttr) ? (typeof minimum === 'number' ? minimum : 0) : minAttr;
      const max = Number.isNaN(maxAttr) ? null : maxAttr;
      const defaultValue = typeof fallback === 'number' ? fallback : min;
      let currentValue = input.value;
      if (currentValue === '' || currentValue === null || Number.isNaN(parseInt(currentValue, 10))) {
        currentValue = defaultValue;
      }
      let next = clampTravelerCount(currentValue, min, max);
      if (next < min) {
        next = min;
      }
      if (typeof max === 'number' && !Number.isNaN(max)) {
        next = Math.min(next, max);
      }
      input.value = String(next);
      return next;
    };

    const ensureTravelerValues = () => {
      ensureTravelerValue(travelerInputs.adults, 1, 1);
      ensureTravelerValue(travelerInputs.children, 0, 0);
      ensureTravelerValue(travelerInputs.infants, 0, 0);
    };

    const removeDocumentListeners = () => {
      if (outsideHandler) {
        document.removeEventListener('mousedown', outsideHandler);
        document.removeEventListener('touchstart', outsideHandler);
        outsideHandler = null;
      }
      if (escHandler) {
        document.removeEventListener('keydown', escHandler);
        escHandler = null;
      }
    };

    const closePopover = () => {
      if (popover && popover.dataset.state === 'open') {
        popover.classList.add('hidden');
        popover.dataset.state = 'closed';
      }
      setExpanded(false);
      removeDocumentListeners();
      if (container) {
        container.classList.remove('quick-add-open');
      }
      if (card) {
        card.classList.remove('quick-add-active');
      }
    };

    const openPopover = () => {
      if (!popover || popover.dataset.state === 'open') {
        return;
      }
      ensureDateValue();
      ensureTravelerValues();
      popover.classList.remove('hidden');
      popover.dataset.state = 'open';
      setExpanded(true);
      if (container) {
        container.classList.add('quick-add-open');
      }
      if (card) {
        card.classList.add('quick-add-active');
      }
      outsideHandler = (event) => {
        if (!form.contains(event.target)) {
          closePopover();
        }
      };
      escHandler = (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closePopover();
        }
      };
      document.addEventListener('mousedown', outsideHandler);
      document.addEventListener('touchstart', outsideHandler);
      document.addEventListener('keydown', escHandler);
      if (dateInput) {
        window.requestAnimationFrame(() => {
          dateInput.focus({ preventScroll: true });
        });
      }
    };

    if (toggleButton && popover) {
      toggleButton.addEventListener('click', (event) => {
        if (toggleButton.getAttribute('data-cart-state') === 'removed') {
          event.preventDefault();
          if (popover.dataset.state === 'open') {
            closePopover();
          } else {
            openPopover();
          }
        } else {
          closePopover();
        }
      });
    }

    if (cancelButton) {
      cancelButton.addEventListener('click', (event) => {
        event.preventDefault();
        closePopover();
      });
    }

    Object.keys(travelerInputs).forEach((key) => {
      const input = travelerInputs[key];
      if (!input) return;
      input.addEventListener('change', ensureTravelerValues);
      input.addEventListener('blur', ensureTravelerValues);
    });

    if (stepButtons.length) {
      stepButtons.forEach((stepButton) => {
        stepButton.addEventListener('click', () => {
          const direction = stepButton.getAttribute('data-quick-add-step');
          const target = stepButton.getAttribute('data-quick-add-target') || 'adults';
          const input = travelerInputs[target] || travelerInputs.adults;
          if (!input) return;
          const minAttr = parseInt(input.getAttribute('min'), 10);
          const maxAttr = parseInt(input.getAttribute('max'), 10);
          const min = Number.isNaN(minAttr) ? (target === 'adults' ? 1 : 0) : minAttr;
          const max = Number.isNaN(maxAttr) ? null : maxAttr;
          const current = clampTravelerCount(input.value, min, max);
          const delta = direction === 'down' ? -1 : 1;
          let next = current + delta;
          if (typeof max === 'number' && !Number.isNaN(max)) {
            next = Math.min(next, max);
          }
          next = Math.max(next, min);
          input.value = String(next);
        });
      });
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      if (!toggleButton) {
        form.submit();
        return;
      }

      ensureDateValue();
      ensureTravelerValues();

      if (typeof window.fetch !== 'function') {
        form.submit();
        return;
      }

      const primaryButton = toggleButton;
      const submitter = event.submitter && event.submitter instanceof HTMLElement ? event.submitter : primaryButton;
      if (submitter && submitter !== primaryButton) {
        submitter.disabled = true;
      }
      primaryButton.disabled = true;
      primaryButton.setAttribute('aria-busy', 'true');

      const formData = new FormData(form);
      if (travelerInputs.adults && travelerInputs.adults.value) {
        formData.set('adults', travelerInputs.adults.value);
      }
      if (travelerInputs.children) {
        formData.set('children', travelerInputs.children.value || '0');
      }
      if (travelerInputs.infants) {
        formData.set('infants', travelerInputs.infants.value || '0');
      }

      if (!formData.get('next')) {
        formData.set('next', window.location.pathname + window.location.search);
      }

      if (dateInput && dateInput.value) {
        formData.set('date', dateInput.value);
      }
      closePopover();

      let shouldFallback = false;

      fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Request failed');
          }
          return response.json();
        })
        .then((data) => {
          setCartButtonState(primaryButton, Boolean(data && data.in_cart));
          updateNavCart(data || {});
        })
        .catch(() => {
          shouldFallback = true;
        })
        .finally(() => {
          primaryButton.disabled = false;
          primaryButton.removeAttribute('aria-busy');
          if (submitter && submitter !== primaryButton) {
            submitter.disabled = false;
          }
          if (shouldFallback) {
            form.submit();
          }
        });
    });
  };

  const initQuickAdd = () => {
    const forms = Array.from(section.querySelectorAll('[data-cart-toggle]'));
  if (!forms.length) {
    return;
  }
  forms.forEach(bindQuickAddForm);
};

window.addEventListener('booking:cart-update', (event) => {
  syncCartButtons(event && event.detail);
});

  const activate = (slug) => {
    if (!slug) return;
    toggles.forEach((button) => {
      const isActive = button.dataset.tripToggle === slug;
      button.classList.toggle('is-active', isActive);
      button.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    panels.forEach((panel) => {
      const isActive = panel.dataset.tripPanel === slug;
      panel.classList.toggle('is-hidden', !isActive);
      panel.hidden = !isActive;
    });
  };

  if (toggles.length) {
    activate(toggles[0].dataset.tripToggle);
  }

  toggles.forEach((button) => {
    button.addEventListener('click', () => activate(button.dataset.tripToggle));
    button.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        activate(button.dataset.tripToggle);
      }
    });
  });

  const initCarousel = (carousel) => {
    if (!carousel || carousel.dataset.tripCarouselBound === 'true') {
      return;
    }
    carousel.dataset.tripCarouselBound = 'true';
    const viewport = carousel.querySelector('[data-trip-viewport]');
    if (!viewport) return;
    const prev = carousel.querySelector('[data-trip-arrow="prev"]');
    const next = carousel.querySelector('[data-trip-arrow="next"]');

    const track = carousel.querySelector('[data-trip-track]');
    const cards = Array.from(track ? track.children : []);

    const update = () => {
      const trackRect = track ? track.scrollWidth : viewport.scrollWidth;
      const maxScroll = Math.max(0, trackRect - viewport.clientWidth);
      if (prev) {
        prev.disabled = viewport.scrollLeft <= 4 || maxScroll <= 0;
      }
      if (next) {
        next.disabled = viewport.scrollLeft >= maxScroll - 4 || maxScroll <= 0;
      }
    };

    if (prev) {
      prev.addEventListener('click', () => {
        viewport.scrollBy({ left: -viewport.clientWidth, behavior: 'smooth' });
      });
    }
    if (next) {
      next.addEventListener('click', () => {
        viewport.scrollBy({ left: viewport.clientWidth, behavior: 'smooth' });
      });
    }

    viewport.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', update, { passive: true });
    update();

    const scheduleUpdate = () => {
      update();
      setTimeout(update, 160);
      setTimeout(update, 600);
    };

    const media = carousel.querySelectorAll('img');
    media.forEach((img) => {
      if (img.complete) {
        scheduleUpdate();
      } else {
        img.addEventListener('load', scheduleUpdate, { once: true });
      }
    });

    window.addEventListener('load', update, { once: true });
  };

  section.querySelectorAll('[data-trip-carousel]').forEach(initCarousel);
  initQuickAdd();
})();
</script>
{% endblock %}
