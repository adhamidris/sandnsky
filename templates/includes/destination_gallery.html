{% load static %}
{% if gallery_items %}
{% with section_id=section_id|default:"destination-gallery" %}
{% with eyebrow_text=eyebrow|default_if_none:""|default:"" %}
{% with heading_text=title|default_if_none:""|default:"" %}
{% with alt_fallback=alt_prefix|default:destination_name|default:heading_text %}
{% with aria_label_text=aria_label|default_if_none:""|default:alt_fallback|default:"Destination gallery" %}
{% with section_label_id=section_id|add:"-title" %}
<section id="{{ section_id }}" class="explore" {% if heading_text %}aria-labelledby="{{ section_label_id }}"{% else %}aria-label="{{ aria_label_text }}"{% endif %}>
  <div class="wrap">
    {% if eyebrow_text %}
    <span class="eyebrow">{{ eyebrow_text }}</span>
    {% endif %}
    {% if heading_text %}
    <h2 id="{{ section_label_id }}">{{ heading_text }}</h2>
    {% endif %}

    <div class="ways-grid">
      <div class="gallery-card-shell span-2">
        <article class="way-card" data-gallery-card data-gallery-primary>
          <img class="switch-img is-active" data-front alt="" />
          <img class="switch-img" data-back alt="" />
          <h3 class="way-title" data-gallery-title></h3>
          <p class="way-desc" data-gallery-desc></p>
        </article>
      </div>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>
    </div>

    <div class="gallery-arrows" data-gallery-arrows>
      <button class="gallery-arrow" type="button" aria-label="Previous" data-gallery-prev>&lsaquo;</button>
      <button class="gallery-arrow" type="button" aria-label="Next" data-gallery-next>&rsaquo;</button>
    </div>
  </div>

  <template id="{{ section_id }}-data">
    {% for item in gallery_items %}
      {% if item.image_url %}
        {% with alt_text=item.caption|default:alt_fallback|default:"Gallery image" %}
        <span data-src="{{ item.image_url|escape }}"
              data-alt="{{ alt_text|escape }}"
              data-title="{{ item.caption|default:alt_text|escape }}"
              data-caption="{{ item.caption|escape }}"></span>
        {% endwith %}
      {% endif %}
    {% endfor %}
  </template>
</section>

{% block script %}
<script>
(() => {
  const sectionId = "{{ section_id|default:'destination-gallery'|escapejs }}";
  const section = document.getElementById(sectionId);
  if (!section) return;

  const tpl = document.getElementById(sectionId + "-data");
  if (!tpl) return;

  const STYLE_ID = `gallery-mobile-style-${sectionId}`;
  if (!document.getElementById(STYLE_ID)) {
    const s = document.createElement("style");
    s.id = STYLE_ID;
    s.textContent = `
      #${sectionId} .wrap {
        position: relative;
      }
      #${sectionId} .ways-grid {
        position: relative;
      }
      #${sectionId} [data-gallery-arrows] {
        --arrow-size: 44px;
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        pointer-events: none;
        z-index: 3;
      }
      #${sectionId} [data-gallery-arrows] .gallery-arrow {
        --arrow-size: 44px;
        pointer-events: auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: var(--arrow-size);
        height: var(--arrow-size);
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, .6);
        background: rgba(0, 0, 0, .35);
        color: #fff;
        font-size: 1.75rem;
        line-height: 1;
        transition: background-color .2s ease, border-color .2s ease;
      }
      #${sectionId} [data-gallery-arrows] .gallery-arrow:focus-visible {
        outline: 2px solid rgba(255, 255, 255, .9);
        outline-offset: 3px;
      }
      #${sectionId} [data-gallery-arrows] .gallery-arrow:hover {
        background: rgba(0, 0, 0, .55);
        border-color: rgba(255, 255, 255, .8);
      }
      @media (max-width:899px) {
        #${sectionId} [data-gallery-card]:not([data-gallery-primary]) {
          display: none !important;
        }
        #${sectionId} .gallery-card-shell {
          position: relative;
          overflow: visible;
        }
        #${sectionId} [data-gallery-arrows] {
          display: block;
          padding: 0;
        }
        #${sectionId} [data-gallery-arrows] .gallery-arrow {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
        }
        #${sectionId} [data-gallery-prev] {
          left: calc(var(--arrow-size) * -0.5);
        }
        #${sectionId} [data-gallery-next] {
          right: calc(var(--arrow-size) * -0.5);
        }
      }

      @media (min-width:900px) {
        #${sectionId} [data-gallery-arrows] {
          left: calc(-1 * ((var(--arrow-size) * 0.5) + clamp(1.5rem, 3vw, 3.5rem)));
          right: calc(-1 * ((var(--arrow-size) * 0.5) + clamp(1.5rem, 3vw, 3.5rem)));
        }
        #${sectionId} [data-gallery-prev],
        #${sectionId} [data-gallery-next] {
          position: static;
          transform: none;
        }
      }
    `;
    document.head.appendChild(s);
  }

  const arrows = section.querySelector('[data-gallery-arrows]');
  const wrap = section.querySelector('.wrap');
  const primaryShell = section.querySelector('.gallery-card-shell');
  const mobileQuery = window.matchMedia('(max-width: 899px)');
  let arrowPlaceholder = null;

  if (arrows && wrap) {
    arrows.style.removeProperty('top');
    arrows.style.removeProperty('transform');
    arrowPlaceholder = document.createElement('span');
    arrowPlaceholder.hidden = true;
    arrowPlaceholder.setAttribute('data-gallery-arrows-slot', 'true');
    wrap.insertBefore(arrowPlaceholder, arrows);
  }

  const syncArrowPlacement = () => {
    if (!arrows) return;

    if (mobileQuery.matches) {
      if (primaryShell && arrows.parentElement !== primaryShell) {
        primaryShell.appendChild(arrows);
      }
    } else if (arrowPlaceholder && arrowPlaceholder.parentNode) {
      const parent = arrowPlaceholder.parentNode;
      if (arrows.parentElement !== parent) {
        parent.insertBefore(arrows, arrowPlaceholder.nextSibling);
      }
    }
  };

  syncArrowPlacement();
  window.addEventListener('resize', syncArrowPlacement, { passive: true });
  window.addEventListener('load', syncArrowPlacement, { once: true });
  if (mobileQuery.addEventListener) {
    mobileQuery.addEventListener('change', syncArrowPlacement);
  } else if (mobileQuery.addListener) {
    mobileQuery.addListener(syncArrowPlacement);
  }

  const nodes = tpl.content.querySelectorAll('[data-src]');
  const imgs = Array.from(nodes).map(n => ({
    src: n.dataset.src,
    alt: n.dataset.alt || "",
    title: n.dataset.title || "",
    caption: n.dataset.caption || ""
  })).filter(x => !!x.src);

  if (!imgs.length) return;

  const cards = Array.from(section.querySelectorAll('[data-gallery-card]'));
  const controllers = [];
  const DURATION_MS = 1200;
  const INTERVAL_MS = 9500;
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const step = Math.max(1, Math.floor(imgs.length / Math.max(1, cards.length)));

  cards.forEach((card, idx) => {
    const front = card.querySelector('[data-front]');
    const back  = card.querySelector('[data-back]');
    const title = card.querySelector('[data-gallery-title]');
    const desc  = card.querySelector('[data-gallery-desc]');

    if (!front || !back || !title || !desc) {
      return;
    }

    let i = (idx * step) % imgs.length;
    let showFront = false;

    const assignActiveMeta = (item, index) => {
      const label = item.title || item.caption || item.alt || "gallery image";
      card.dataset.currentIndex = String(index);
      card.dataset.currentTitle = label;
      card.setAttribute("aria-label", `View ${label}`);
    };

    const setContent = (el, item) => {
      el.src = item.src;
      el.alt = item.alt || item.title || item.caption || "Gallery image";
      title.textContent = item.title || item.caption || '';
      desc.textContent  = item.caption || '';
    };

    setContent(front, imgs[i]);
    i = (i + 1) % imgs.length;
    const initialItem = imgs[i];
    setContent(back, initialItem);
    assignActiveMeta(initialItem, i);
    back.classList.add('is-active');

    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.classList.add('gallery-card--interactive');

    const activate = (event) => {
      if (event.type === 'keydown' && event.key !== 'Enter' && event.key !== ' ') {
        return;
      }
      event.preventDefault();
      const rawIndex = Number(card.dataset.currentIndex || '0');
      const safeIndex = Number.isFinite(rawIndex) ? rawIndex : 0;
      openLightbox(safeIndex);
    };
    card.addEventListener('click', activate);
    card.addEventListener('keydown', activate);

    const tick = () => {
      i = (i + 1) % imgs.length;

      const entering = showFront ? front : back;
      const exiting  = showFront ? back  : front;
      const nextItem = imgs[i];

      setContent(entering, nextItem);
      assignActiveMeta(nextItem, i);

      entering.classList.add('is-active');
      exiting.classList.add('is-exit');
      exiting.classList.remove('is-active');

      const clear = () => exiting.classList.remove('is-exit');
      if (prefersReduced) {
        setTimeout(clear, Math.min(350, DURATION_MS));
      } else {
        exiting.addEventListener('transitionend', clear, { once: true });
      }

      showFront = !showFront;
    };

    const prev = () => { i = (i - 2 + imgs.length) % imgs.length; tick(); };
    controllers.push({ next: tick, prev });

    const jitter = Math.random() * 800;
    setTimeout(() => {
      tick();
      setInterval(tick, INTERVAL_MS + Math.random() * 900);
    }, jitter);
  });

  const prevBtn = section.querySelector("[data-gallery-prev]");
  const nextBtn = section.querySelector("[data-gallery-next]");
  const advance = (dir) => controllers.forEach(c => dir === "prev" ? c.prev() : c.next());
  if (prevBtn) prevBtn.addEventListener("click", () => advance("prev"));
  if (nextBtn) nextBtn.addEventListener("click", () => advance("next"));

  let overlay;
  let overlayDialog;
  let overlayImg;
  let overlayTitle;
  let overlayCaption;
  let overlayPrev;
  let overlayNext;
  let lightboxIndex = 0;

  function ensureLightbox() {
    if (overlay) return;

    overlay = document.getElementById('gallery-lightbox');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'gallery-lightbox';
      overlay.className = 'gallery-lightbox';
      overlay.setAttribute('aria-hidden', 'true');
      overlay.innerHTML = `
        <div class="gallery-lightbox__backdrop" data-lightbox-close></div>
        <div class="gallery-lightbox__dialog" data-lightbox-dialog role="dialog" aria-modal="true" aria-label="Expanded gallery image" tabindex="-1">
          <button class="gallery-lightbox__close" type="button" aria-label="Close gallery" data-lightbox-close>&times;</button>
          <button class="gallery-lightbox__nav gallery-lightbox__nav--prev" type="button" aria-label="Previous image" data-lightbox-prev>&lsaquo;</button>
          <button class="gallery-lightbox__nav gallery-lightbox__nav--next" type="button" aria-label="Next image" data-lightbox-next>&rsaquo;</button>
          <div class="gallery-lightbox__media">
            <img data-lightbox-image alt="" />
          </div>
          <div class="gallery-lightbox__meta">
            <h3 class="gallery-lightbox__title" data-lightbox-title></h3>
            <p class="gallery-lightbox__caption" data-lightbox-caption></p>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    overlay.setAttribute('aria-hidden', 'true');

    overlayDialog = overlay.querySelector('[data-lightbox-dialog]');
    overlayImg = overlay.querySelector('[data-lightbox-image]');
    overlayTitle = overlay.querySelector('[data-lightbox-title]');
    overlayCaption = overlay.querySelector('[data-lightbox-caption]');
    overlayPrev = overlay.querySelector('[data-lightbox-prev]');
    overlayNext = overlay.querySelector('[data-lightbox-next]');

    overlayDialog.addEventListener('click', (event) => event.stopPropagation());

    overlay.addEventListener('click', (event) => {
      if (event.target === overlay || event.target.dataset.lightboxClose !== undefined) {
        closeLightbox();
      }
    });

    overlay.querySelectorAll('[data-lightbox-close]').forEach(btn => {
      btn.addEventListener('click', closeLightbox);
    });

    if (overlayPrev) {
      overlayPrev.hidden = imgs.length <= 1;
      overlayPrev.addEventListener('click', (event) => {
        event.preventDefault();
        offsetLightbox(-1);
      });
    }
    if (overlayNext) {
      overlayNext.hidden = imgs.length <= 1;
      overlayNext.addEventListener('click', (event) => {
        event.preventDefault();
        offsetLightbox(1);
      });
    }
  }

  function showLightboxItem(index) {
    if (!imgs.length) return;

    const total = imgs.length;
    lightboxIndex = ((index % total) + total) % total;

    ensureLightbox();

    const item = imgs[lightboxIndex];
    overlayImg.src = item.src;
    overlayImg.alt = item.alt || item.title || item.caption || 'Gallery image';

    if (overlayTitle) {
      overlayTitle.textContent = item.title || '';
      overlayTitle.hidden = !overlayTitle.textContent;
    }

    if (overlayCaption) {
      overlayCaption.textContent = item.caption || '';
      overlayCaption.hidden = !overlayCaption.textContent;
    }
  }

  function offsetLightbox(delta) {
    showLightboxItem(lightboxIndex + delta);
  }

  function openLightbox(index) {
    ensureLightbox();
    showLightboxItem(index);

    overlay.classList.add('is-visible');
    overlay.setAttribute('aria-hidden', 'false');
    document.body.classList.add('is-lightbox-open');

    requestAnimationFrame(() => {
      if (overlayDialog) {
        overlayDialog.focus({ preventScroll: true });
      }
    });
  }

  function closeLightbox() {
    if (!overlay) return;

    overlay.classList.remove('is-visible');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('is-lightbox-open');
  }

  function handleLightboxKeydown(event) {
    if (!overlay || !overlay.classList.contains('is-visible')) return;

    const key = event.key;
    if (key === 'Escape') {
      event.preventDefault();
      closeLightbox();
    } else if (key === 'ArrowRight') {
      event.preventDefault();
      offsetLightbox(1);
    } else if (key === 'ArrowLeft') {
      event.preventDefault();
      offsetLightbox(-1);
    }
  }

  document.addEventListener('keydown', handleLightboxKeydown);
})();
</script>
{% endblock %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endif %}
