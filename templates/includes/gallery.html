{% load static %}
{% if gallery_section.items or gallery_section.rows %}
<section id="gallery" class="explore" aria-labelledby="explore-title">
  <div class="wrap">
    <span class="eyebrow">Gallery</span>
    <h2 id="explore-title">{{ gallery_section.title }}</h2>

    <div class="ways-grid">

      <div class="gallery-card-shell span-2">
        <article class="way-card" data-gallery-card data-gallery-primary>
          <img class="switch-img is-active" data-front alt="" />
          <img class="switch-img" data-back alt="" />
          <h3 class="way-title" data-gallery-title></h3>
          <p class="way-desc" data-gallery-desc></p>
        </article>
      </div>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

      <article class="way-card" data-gallery-card>
        <img class="switch-img is-active" data-front alt="" />
        <img class="switch-img" data-back alt="" />
        <h3 class="way-title" data-gallery-title></h3>
        <p class="way-desc" data-gallery-desc></p>
      </article>

<!-- was: <aside class="way-card gallery-cta" aria-label="Gallery CTA"> -->
  <aside class="gallery-cta" aria-label="Gallery CTA">
    <div class="gallery-cta-inner">
      <span class="cta-eyebrow">Gallery</span>
      <h3 class="cta-title">Explore the beauty of Egypt</h3>
      <p class="cta-desc">From timeless temples to silent seas of sand — see our favourite moments.</p>
      <a class="cta-link" href="/gallery">View all gallery</a>
    </div>
  </aside>

    </div>

    <div class="gallery-arrows" data-gallery-arrows>

      <button class="gallery-arrow" type="button" aria-label="Previous" data-gallery-prev>&lsaquo;</button>

      <button class="gallery-arrow" type="button" aria-label="Next" data-gallery-next>&rsaquo;</button>

    </div>
  </div>

  {# Hidden data source (no visuals, fed to JS). We prefer rows; fallback to items. #}
  <template id="gallery-data">
    {% if gallery_section.rows %}
      {% for row in gallery_section.rows %}
        {% for item in row %}
          <span data-src="{{ item.image_url }}"
                data-alt="{{ item.alt }}"
                data-caption="{{ item.caption|default:item.destination }}"></span>
        {% endfor %}
      {% endfor %}
    {% else %}
      {% for item in gallery_section.items %}
        {% if item.image_url %}
          <span data-src="{{ item.image_url }}"
                data-alt="{{ item.alt }}"
                data-caption="{{ item.caption|default:item.destination }}"></span>
        {% endif %}
      {% endfor %}
    {% endif %}
  </template>
</section>
{% endif %}

{% block script %}
<script>
(() => {
  const section = document.getElementById('gallery');
  if (!section) return;

  const tpl = document.getElementById('gallery-data');
  if (!tpl) return;

  // Ensure mobile only shows a single gallery row and expose swipe arrows
  const STYLE_ID = "gallery-mobile-style";
  if (!document.getElementById(STYLE_ID)) {
    const s = document.createElement("style");
    s.id = STYLE_ID;
    s.textContent = `
      #gallery .wrap {
        position: relative;
      }
      #gallery .ways-grid {
        position: relative;
      }
      #gallery [data-gallery-arrows] {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        pointer-events: none;
        z-index: 3;
      }
      #gallery [data-gallery-arrows] .gallery-arrow {
        --arrow-size: 44px;
        pointer-events: auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: var(--arrow-size);
        height: var(--arrow-size);
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, .6);
        background: rgba(0, 0, 0, .35);
        color: #fff;
        font-size: 1.75rem;
        line-height: 1;
        transition: background-color .2s ease, border-color .2s ease;
      }
      #gallery [data-gallery-arrows] .gallery-arrow:focus-visible {
        outline: 2px solid rgba(255, 255, 255, .9);
        outline-offset: 3px;
      }
      #gallery [data-gallery-arrows] .gallery-arrow:hover {
        background: rgba(0, 0, 0, .55);
        border-color: rgba(255, 255, 255, .8);
      }
      @media (max-width:899px) {
        #gallery [data-gallery-card]:not([data-gallery-primary]) {
          display: none !important;
        }
        #gallery .gallery-card-shell {
          position: relative;
          overflow: visible;
        }
        #gallery [data-gallery-arrows] {
          display: block;
          padding: 0;
        }
        #gallery [data-gallery-arrows] .gallery-arrow {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
        }
        #gallery [data-gallery-prev] {
          left: calc(var(--arrow-size) * -0.5);
        }
        #gallery [data-gallery-next] {
          right: calc(var(--arrow-size) * -0.5);
        }
      }

      @media (min-width:900px) {
        #gallery [data-gallery-prev],
        #gallery [data-gallery-next] {
          position: static;
          transform: none;
        }
      }
    `;
    document.head.appendChild(s);
  }
  const arrows = section.querySelector('[data-gallery-arrows]');
  const wrap = section.querySelector('.wrap');
  const primaryShell = section.querySelector('.gallery-card-shell');
  const mobileQuery = window.matchMedia('(max-width: 899px)');
  let arrowPlaceholder = null;

  if (arrows && wrap) {
    arrows.style.removeProperty('top');
    arrows.style.removeProperty('transform');
    arrowPlaceholder = document.createElement('span');
    arrowPlaceholder.hidden = true;
    arrowPlaceholder.setAttribute('data-gallery-arrows-slot', 'true');
    wrap.insertBefore(arrowPlaceholder, arrows);
  }

  const syncArrowPlacement = () => {
    if (!arrows) return;

    if (mobileQuery.matches) {
      if (primaryShell && arrows.parentElement !== primaryShell) {
        primaryShell.appendChild(arrows);
      }
    } else if (arrowPlaceholder && arrowPlaceholder.parentNode) {
      const parent = arrowPlaceholder.parentNode;
      if (arrows.parentElement !== parent) {
        parent.insertBefore(arrows, arrowPlaceholder.nextSibling);
      }
    }
  };

  syncArrowPlacement();
  window.addEventListener('resize', syncArrowPlacement, { passive: true });
  window.addEventListener('load', syncArrowPlacement, { once: true });
  if (mobileQuery.addEventListener) {
    mobileQuery.addEventListener('change', syncArrowPlacement);
  } else if (mobileQuery.addListener) {
    mobileQuery.addListener(syncArrowPlacement);
  }

  // Extract images array from template
  const nodes = tpl.content.querySelectorAll('[data-src]');
  const imgs = Array.from(nodes).map(n => ({
    src: n.dataset.src,
    alt: n.dataset.alt || "",
    caption: n.dataset.caption || ""
  })).filter(x => !!x.src);

  if (!imgs.length) return;

  const cards = Array.from(section.querySelectorAll('[data-gallery-card]'));

    const controllers = [];
  const DURATION_MS = 900;     // must match CSS transition
  const INTERVAL_MS = 6500;    // time each image is shown
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Space out starting indices so cards don't duplicate the same image at once
  const step = Math.max(1, Math.floor(imgs.length / Math.max(1, cards.length)));

  cards.forEach((card, idx) => {
    const front = card.querySelector('[data-front]');
    const back  = card.querySelector('[data-back]');
    const title = card.querySelector('[data-gallery-title]');
    const desc  = card.querySelector('[data-gallery-desc]');

    let i = (idx * step) % imgs.length;
    let showFront = false; // we'll start by showing "back" for even preload

    function setContent(el, item){
      el.src = item.src;
      el.alt = item.alt;
      title.textContent = item.caption || '';
      desc.textContent  = item.alt || '';
    }

    // Initial content
    setContent(front, imgs[i]); i = (i + 1) % imgs.length;
    setContent(back,  imgs[i]);

    // Make "back" visible first so both are preloaded
    back.classList.add('is-active');

    const tick = () => {
      i = (i + 1) % imgs.length;

      const entering = showFront ? front : back;
      const exiting  = showFront ? back  : front;

      // Prepare next image on the hidden layer
      setContent(entering, imgs[i]);

      // Trigger swipe: exiting slides left, entering slides from right
      entering.classList.add('is-active');       // opacity:1, translateX(0)
      exiting.classList.add('is-exit');          // opacity:0, translateX(-8%)
      exiting.classList.remove('is-active');

      // Clean up exit class after transition ends
      const clear = () => exiting.classList.remove('is-exit');
      if (prefersReduced) {
        // minimal animations: shorter cleanup
        setTimeout(clear, Math.min(350, DURATION_MS));
      } else {
        exiting.addEventListener('transitionend', clear, { once: true });
      }

      showFront = !showFront;
    };
        const prev = () => { i = (i - 2 + imgs.length) % imgs.length; tick(); };
        controllers.push({ next: tick, prev });

    // Start loop with a small desync jitter so all cards aren’t in lockstep
    const jitter = Math.random() * 800;
    setTimeout(() => {
      tick();
      setInterval(tick, INTERVAL_MS + Math.random() * 900);
    }, jitter);
  });
    const prevBtn = section.querySelector("[data-gallery-prev]");
    const nextBtn = section.querySelector("[data-gallery-next]");
    const adv = (d) => controllers.forEach(c => d === "prev" ? c.prev() : c.next());
    if (prevBtn) prevBtn.addEventListener("click", () => adv("prev"));
    if (nextBtn) nextBtn.addEventListener("click", () => adv("next"));
})();
</script>
{% endblock %}
