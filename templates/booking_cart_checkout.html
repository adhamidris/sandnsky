{% extends "base.html" %}
{% load static %}

{% block title %}Booking List · Sand & Sky Tours{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/main2.css' %}" />
{% endblock %}

{% block content %}
<section class="bg-muted/20 py-16">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <h1 class="mb-6 text-center font-serif text-3xl text-foreground sm:text-4xl lg:hidden">Review &amp; confirm your booking list</h1>
  </div>
  <div class="mx-auto grid max-w-6xl gap-8 px-4 sm:px-6 lg:grid-cols-[2fr,1fr] lg:gap-12 lg:px-8">
    {% if messages %}
    <div class="lg:col-span-2">
      <div class="rounded-3xl border border-border bg-card p-4 shadow-[var(--shadow-subtle)]">
        <ul class="space-y-2 text-sm">
          {% for message in messages %}
          <li class="font-medium {% if message.tags == 'success' %}text-primary{% elif message.tags == 'error' %}text-destructive{% else %}text-muted-foreground{% endif %}">{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    <aside class="order-1 lg:order-2 lg:col-start-2 lg:row-start-1">
      <div class="rounded-3xl bg-card p-6 shadow-[var(--shadow-medium)]">
        <h2 class="text-lg font-semibold text-foreground">Guest details</h2>
        <p class="mt-1 text-sm text-muted-foreground">We use this information to tailor your quote and follow up with availability.</p>
        <form id="cart-checkout-form" method="post" action="{% url 'web:booking-cart-checkout' %}" class="mt-6 space-y-5">
          {% csrf_token %}
          <input type="hidden" name="action" value="confirm" />
          {% for field in form %}
          <div>
            <label class="flex justify-between text-sm font-medium text-foreground" for="{{ field.id_for_label }}">
              <span>{{ field.label }}</span>
              {% if field.field.required %}<span class="text-primary">*</span>{% endif %}
            </label>
            {{ field }}
            {% if field.errors %}
            <p class="mt-1 text-sm text-destructive">{{ field.errors|striptags }}</p>
            {% endif %}
          </div>
          {% endfor %}
        </form>
      </div>
    </aside>

    <div class="order-2 lg:order-1 lg:col-start-1 lg:row-start-1 lg:row-span-2">
      <div class="space-y-6">
        <header class="hidden space-y-2 lg:block">
          <p class="text-sm uppercase tracking-wide text-muted-foreground">Your curated adventures</p>
          <h1 class="font-serif text-4xl text-foreground">Review &amp; confirm your booking list</h1>
          <p class="text-sm text-muted-foreground">Fine-tune your selection, update traveler details, and submit everything in one go. You can still book individual trips directly from each trip page.</p>
        </header>

        {% if cart_has_entries %}
        <div class="divide-y divide-border overflow-hidden rounded-3xl bg-card shadow-[var(--shadow-subtle)]" data-cart-entries>
          {% for entry in cart_entries %}
          <article
            class="flex flex-col gap-5 p-6 sm:flex-row sm:items-start sm:justify-between sm:gap-6"
            id="cart-entry-{{ entry.id }}"
            data-entry
            data-entry-id="{{ entry.id }}"
            data-trip-id="{{ entry.trip_id }}"
            data-trip-slug="{{ entry.trip_slug }}"
          >
            <div class="space-y-3">
              <h2 class="font-serif text-xl text-foreground">{{ entry.trip_title }}</h2>
              <ul class="text-sm text-muted-foreground">
                {% if entry.travel_date_display %}<li><span class="font-medium text-foreground">Trip date:</span> {{ entry.travel_date_display }}</li>{% endif %}
                <li><span class="font-medium text-foreground">Travelers:</span> {{ entry.traveler_label }}</li>
              </ul>
              <div class="flex flex-wrap gap-3 text-sm">
                {% if entry.trip_slug %}
                <a href="{% url 'web:trip-detail' entry.trip_slug %}#booking-form" class="inline-flex items-center gap-1 rounded-full bg-primary/10 px-3 py-1 font-semibold text-primary transition hover:bg-primary/20">
                  Edit trip
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 19.5 10.5M16.5 7.5 8.25 15.75 6 18l2.25-.75L16.5 9" />
                  </svg>
                </a>
                {% endif %}
                <form method="post" action="{% url 'web:booking-cart-checkout' %}" class="inline-flex">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="remove" />
                  <input type="hidden" name="entry_id" value="{{ entry.id }}" />
                  <button type="submit" class="inline-flex items-center gap-1 rounded-full bg-muted px-3 py-1 font-semibold text-muted-foreground transition hover:bg-muted/70">
                    Remove
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                  </button>
                </form>
              </div>
              <div class="rounded-3xl border border-border/60 bg-background/50 p-4" data-entry-reward-box>
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <p class="text-sm font-semibold text-foreground">Rewards</p>
                    {% if entry.applied_reward %}
                    <p class="text-xs text-muted-foreground" data-entry-reward-status>
                      Applied <span class="font-medium text-foreground">{{ entry.applied_reward.phase_name }}</span> · Saved {{ entry.applied_reward.discount_display }}
                    </p>
                    {% else %}
                    <p class="text-xs text-muted-foreground" data-entry-reward-status>No reward applied yet. Choose an unlocked phase below.</p>
                    {% endif %}
                  </div>
                  <div class="flex flex-wrap items-center gap-2" data-entry-reward-actions>
                    {% if entry.applied_reward %}
                    <button
                      type="button"
                      class="inline-flex items-center gap-1 rounded-full border border-destructive/40 px-3 py-1 text-xs font-semibold text-destructive transition hover:bg-destructive/10"
                      data-action="remove-reward"
                      data-entry-id="{{ entry.id }}"
                    >
                      Remove discount
                    </button>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-3 flex flex-wrap gap-2" data-entry-option-list>
                  {% for phase in cart_summary.rewards.phases %}
                  {% for trip in phase.trip_options %}
                  {% if trip.trip_id == entry.trip_id %}
                  {% if phase.unlocked %}
                  {% if not entry.applied_reward or entry.applied_reward.phase_id != phase.id %}
                  <button
                    type="button"
                    class="inline-flex items-center gap-1 rounded-full border border-primary/40 bg-background px-3 py-1 text-xs font-semibold text-primary transition hover:bg-primary/10"
                    data-action="apply-reward"
                    data-entry-id="{{ entry.id }}"
                    data-phase-id="{{ phase.id }}"
                    data-trip-id="{{ trip.trip_id }}"
                  >
                    Apply {{ phase.name }}
                  </button>
                  {% endif %}
                  {% else %}
                  <span class="inline-flex items-center gap-1 rounded-full border border-dashed border-muted px-3 py-1 text-xs font-semibold text-muted-foreground" data-entry-locked-option data-phase-id="{{ phase.id }}">
                    Unlock at {{ phase.threshold_amount_display }}
                  </span>
                  {% endif %}
                  {% endif %}
                  {% endfor %}
                  {% endfor %}
                </div>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="rounded-full bg-primary/10 px-4 py-1 text-sm font-semibold text-primary" data-entry-total>{{ entry.currency }} {{ entry.grand_total_display }}</span>
              <span class="text-xs text-muted-foreground line-through {% if not entry.discount_total_cents %}hidden{% endif %}" data-entry-original>{{ entry.currency }} {{ entry.original_grand_total_display }}</span>
              {% if entry.applied_reward %}
              <span class="inline-flex items-center gap-1 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary" data-entry-discount-pill>
                Saved {{ entry.applied_reward.discount_display }}
              </span>
              {% else %}
              <span class="hidden inline-flex items-center gap-1 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary" data-entry-discount-pill></span>
              {% endif %}
              {% if entry.trip_slug %}
              <a href="{% url 'web:trip-detail' entry.trip_slug %}" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground hover:text-primary">View trip details</a>
              {% endif %}
            </div>
          </article>
          {% endfor %}
        </div>

        <div class="rounded-3xl bg-card p-6 shadow-[var(--shadow-subtle)]">
          <h2 class="text-lg font-semibold text-foreground">Summary</h2>
          <dl class="mt-4 space-y-3 text-sm text-muted-foreground">
            <div class="flex justify-between">
              <dt>Trips in list</dt>
              <dd class="font-semibold text-foreground" data-summary-count>{{ cart_summary.count }}</dd>
            </div>
            <div class="flex justify-between">
              <dt>Pre-discount total</dt>
              <dd class="font-semibold text-foreground" data-summary-pre-discount>{{ cart_currency }} {{ cart_summary.pre_discount_total_display }}</dd>
            </div>
            <div class="flex justify-between text-primary">
              <dt>Rewards savings</dt>
              <dd class="font-semibold" data-summary-discount>{{ cart_currency }} {{ cart_summary.discount_total_display }}</dd>
            </div>
            <div class="flex justify-between">
              <dt>Updated total</dt>
              <dd class="font-semibold text-foreground" data-summary-total>{{ cart_currency }} {{ cart_total_display }}</dd>
            </div>
          </dl>
          <div class="mt-4">
            <a href="{% url 'web:trips' %}" class="inline-flex items-center gap-2 text-sm font-semibold text-primary hover:text-primary/80">
              Add another trip
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
            </a>
          </div>
          <button type="submit" form="cart-checkout-form" class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-primary to-primary/80 px-5 py-2.5 text-sm font-semibold text-primary-foreground shadow-sm transition hover:from-primary/90 hover:to-primary/80" >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="m5 12 4 4 10-10" />
            </svg>
            Confirm booking list
          </button>
        </div>

        <section
          class="rounded-3xl bg-card p-6 shadow-[var(--shadow-subtle)]"
          data-cart-rewards-root
          data-summary-url="{% url 'web:booking-cart-rewards' %}"
          data-apply-url="{% url 'web:booking-cart-rewards-apply' %}"
          data-remove-url="{% url 'web:booking-cart-rewards-remove' %}"
          data-currency="{{ cart_currency }}"
        >
          <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-muted-foreground">Progressive rewards</p>
              <h2 class="mt-1 font-serif text-2xl text-foreground">Unlock exclusive savings as you build your trip</h2>
            </div>
            <p class="text-sm text-muted-foreground lg:max-w-sm">Every unlocked phase grants a discount that applies automatically to everyone travelling on the selected trip.</p>
          </div>
          <div class="mt-6 grid gap-6 lg:grid-cols-[220px_minmax(0,1fr)]">
            <div class="space-y-4" data-reward-progress-column>
              {% with rewards=cart_summary.rewards %}
              {% if rewards.phases %}
              {% with phases=rewards.phases progress=rewards.progress final_phase=rewards.phases|last %}
              {% with max_threshold=final_phase.threshold_amount_cents|default_if_none:1 %}
              {% widthratio progress.total_cents max_threshold 100 as progress_percent %}
              <div class="rounded-3xl border border-border bg-background/60 p-5">
                <div class="space-y-5">
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
                    <div>
                      <p class="text-xs uppercase tracking-wide text-muted-foreground">Current cart total</p>
                      <p class="font-serif text-3xl text-foreground">{{ progress.currency }} {{ progress.total_display }}</p>
                    </div>
                    <div class="text-sm text-muted-foreground sm:max-w-xs">
                      {% if progress.next_phase_id %}
                      {% for phase in phases %}
                      {% if phase.id == progress.next_phase_id %}
                      You're {{ progress.remaining_to_next_display }} away from unlocking <span class="font-medium text-foreground">{{ phase.name }}</span>.
                      {% endif %}
                      {% endfor %}
                      {% else %}
                      You've unlocked every available reward. Nice work!
                      {% endif %}
                    </div>
                  </div>
                  <div>
                    <div class="relative">
                      <div class="relative h-2 w-full rounded-full bg-muted" data-reward-progress-track data-total-cents="{{ progress.total_cents }}" data-max-threshold="{{ max_threshold }}">
                        <div class="absolute left-0 top-0 h-full rounded-full bg-primary transition-all" style="width: {{ progress_percent }}%;" data-reward-progress-fill></div>
                        {% for phase in phases %}
                        {% widthratio phase.threshold_amount_cents max_threshold 100 as marker_percent %}
                        <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2" style="left: {{ marker_percent }}%;" data-reward-progress-marker data-phase-id="{{ phase.id }}">
                          <span class="block h-3 w-3 rounded-full border-2 {% if phase.unlocked %}border-primary bg-primary{% else %}border-muted bg-background{% endif %}"></span>
                        </div>
                        {% endfor %}
                      </div>
                      <div class="pointer-events-none relative mt-6 h-12 text-center text-[0.65rem] text-muted-foreground">
                        {% for phase in phases %}
                        {% widthratio phase.threshold_amount_cents max_threshold 100 as label_percent %}
                        <div class="absolute left-0 -translate-x-1/2" style="left: {{ label_percent }}%;" data-reward-progress-label data-phase-id="{{ phase.id }}">
                          <span class="block font-semibold uppercase tracking-wide {% if phase.unlocked %}text-foreground{% else %}text-muted-foreground{% endif %}">Phase {{ forloop.counter }}</span>
                          <span class="block text-muted-foreground">{{ phase.threshold_amount_display }}</span>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                  <div class="rounded-2xl bg-primary/10 p-3 text-xs text-primary">
                    <p class="font-semibold">Unlocked phases:</p>
                    {% if progress.unlocked_phase_ids %}
                    <p class="mt-1">{{ progress.unlocked_phase_ids|length }} of {{ phases|length }} active phase{{ phases|length|pluralize }} unlocked.</p>
                    {% else %}
                    <p class="mt-1">Add a little more to begin unlocking 50% off rewards.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endwith %}
              {% endwith %}
              {% else %}
              <div class="rounded-3xl border border-border bg-background/60 p-5 text-sm text-muted-foreground">
                <p class="font-semibold text-foreground">Rewards configuration coming soon.</p>
                <p class="mt-2">Add reward phases in the admin to unlock progressive savings during checkout.</p>
              </div>
              {% endif %}
              {% endwith %}
              <div class="rounded-3xl border border-primary/30 bg-gradient-to-br from-primary/10 via-primary/5 to-transparent p-5 text-sm text-muted-foreground">
                <h3 class="text-base font-semibold text-foreground">How it works</h3>
                <ul class="mt-3 space-y-2">
                  <li class="flex items-start gap-2"><span class="mt-0.5 h-2 w-2 rounded-full bg-primary"></span><span>Reach each threshold to unlock a new phase of curated trips.</span></li>
                  <li class="flex items-start gap-2"><span class="mt-0.5 h-2 w-2 rounded-full bg-primary"></span><span>Apply the reward to one eligible trip and everyone in your group receives the discount.</span></li>
                  <li class="flex items-start gap-2"><span class="mt-0.5 h-2 w-2 rounded-full bg-primary"></span><span>Progressive rewards stack, so higher tiers keep the earlier perks.</span></li>
                </ul>
              </div>
            </div>
            <div class="space-y-4" data-reward-phase-list>
              {% for phase in cart_summary.rewards.phases %}
              <article class="rounded-3xl border border-border bg-background/80 p-5 transition {% if not phase.unlocked %}opacity-50{% endif %}" data-reward-phase data-phase-id="{{ phase.id }}" data-phase-unlocked="{{ phase.unlocked|yesno:'true,false' }}">
                <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between">
                  <div>
                    <p class="text-xs uppercase tracking-wide text-muted-foreground">Phase {{ forloop.counter }}</p>
                    <h3 class="font-serif text-xl text-foreground">{{ phase.name }}</h3>
                    <p class="text-sm text-muted-foreground">Unlock at {{ phase.currency }} {{ phase.threshold_amount_display }} · {{ phase.discount_percent|floatformat:0 }}% off</p>
                  </div>
                  <div class="flex items-center gap-2 text-xs font-semibold">
                    {% if phase.unlocked %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-primary/10 px-3 py-1 text-primary">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                        <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 0 1.414l-6.764 6.764a1 1 0 0 1-1.414 0l-3.53-3.53a1 1 0 0 1 1.414-1.414l2.823 2.823 6.057-6.057a1 1 0 0 1 1.414 0Z" clip-rule="evenodd" />
                      </svg>
                      Unlocked
                    </span>
                    {% else %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-muted px-3 py-1 text-muted-foreground">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                        <path d="M10 2a5 5 0 0 1 5 5v2h1a1 1 0 0 1 0 2h-1v4a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V11H4a1 1 0 1 1 0-2h1V7a5 5 0 0 1 5-5Zm-3 7h6V7a3 3 0 1 0-6 0v2Z" />
                      </svg>
                      Locked
                    </span>
                    {% endif %}
                  </div>
                </div>
                {% if phase.headline %}
                <p class="mt-2 text-sm font-medium text-foreground">{{ phase.headline }}</p>
                {% elif phase.description %}
                <p class="mt-2 text-sm text-muted-foreground">{{ phase.description }}</p>
                {% endif %}
                <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3" data-reward-phase-trips>
                  {% for trip in phase.trip_options %}
                  <button
                    type="button"
                    class="group relative overflow-hidden rounded-2xl border border-border bg-background text-left transition focus:outline-none focus:ring-2 focus:ring-primary {% if not phase.unlocked %}pointer-events-none{% endif %}"
                    data-reward-trip
                    data-phase-id="{{ phase.id }}"
                    data-trip-id="{{ trip.trip_id }}"
                    {% if not phase.unlocked %}disabled{% endif %}
                  >
                    {% if trip.card_image_url %}
                    <img src="{{ trip.card_image_url }}" alt="{{ trip.title }}" class="h-24 w-full object-cover transition group-hover:scale-105" />
                    {% else %}
                    <div class="flex h-24 w-full items-center justify-center bg-muted text-xs font-semibold uppercase tracking-wide text-muted-foreground">No image</div>
                    {% endif %}
                    <div class="p-3">
                      <p class="text-xs font-semibold text-foreground">{{ trip.title }}</p>
                    </div>
                  </button>
                  {% endfor %}
                </div>
                {% if phase.applied_entry_ids %}
                <div class="mt-4 rounded-2xl bg-primary/10 p-3 text-xs text-primary" data-phase-applied-target>
                  <p class="font-semibold">Applied to:</p>
                  <ul class="mt-1 space-y-1">
                    {% for entry in cart_entries %}
                    {% if entry.id in phase.applied_entry_ids %}
                    <li>{{ entry.trip_title }}</li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
              </article>
              {% endfor %}
            </div>
          </div>
          <div class="mt-4 hidden rounded-2xl border border-destructive/40 bg-destructive/10 p-4 text-sm font-semibold text-destructive" data-rewards-alert role="status"></div>
        </section>
        {{ cart_summary|json_script:"cart-summary-state" }}
        {% else %}
        <div class="rounded-3xl bg-card p-10 text-center shadow-[var(--shadow-subtle)]">
          <p class="text-lg font-semibold text-foreground">Your booking list is empty.</p>
          <p class="mt-2 text-sm text-muted-foreground">Explore our curated journeys and add the ones you love. You can return here whenever you're ready.</p>
          <a href="{% url 'web:trips' %}" class="mt-6 inline-flex items-center justify-center rounded-full bg-primary px-6 py-3 text-sm font-semibold text-primary-foreground transition hover:bg-primary/90">Browse trips</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/cart-rewards.js' %}"></script>
{% endblock %}
