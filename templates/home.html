{% extends "base.html" %}

{% block title %}Sand & Sky Tours{% endblock %}

{% block content %}
{% include "includes/hero.html" with hero=hero %}
{% include "includes/about.html" with about_section=about_section %}
{% include "includes/destinations.html" with destinations_section=destinations_section %}
{% include "includes/features.html" with features_section=features_section %}
{% include "includes/testimonials.html" %}
{% include "includes/gallery_marquee.html" with gallery_section=gallery_section %}
{% include "includes/blog_highlights.html" with blog_section=blog_section %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function () {
  var heroVideo = document.querySelector('[data-hero-video]');
  if (heroVideo) {
    heroVideo.muted = true;
    heroVideo.setAttribute('muted', '');

    function attemptPlay() {
      var playPromise = heroVideo.play();
      if (playPromise && playPromise.catch) {
        playPromise.catch(function (err) {
          console.warn('Hero video playback blocked:', err);
          heroVideo.setAttribute('data-hero-video-blocked', 'true');
        });
      }
    }

    if (heroVideo.readyState >= 2) {
      attemptPlay();
    } else {
      heroVideo.addEventListener('loadeddata', attemptPlay, { once: true });
    }

    heroVideo.addEventListener('error', function (event) {
      console.error('Hero video failed to load', event);
      heroVideo.setAttribute('data-hero-video-error', 'true');
    });
  }

  var slider = document.querySelector('[data-testimonials]');
  if (!slider) {
    return;
  }

  var cards = slider.querySelectorAll('[data-testimonial]');
  var dots = slider.querySelectorAll('[data-testimonial-dot]');
  if (!cards.length) {
    return;
  }

  var interval = parseInt(slider.dataset.interval, 10);
  if (Number.isNaN(interval) || interval <= 0) {
    interval = 6000;
  }

  var current = 0;
  var timer = null;

  function updateCardStates(options) {
    var prevIndex = (current - 1 + cards.length) % cards.length;
    var nextIndex = (current + 1) % cards.length;

    cards.forEach(function (card) {
      card.classList.remove('is-active', 'is-prev', 'is-next');
      card.setAttribute('aria-hidden', 'true');
    });

    if (cards[current]) {
      cards[current].classList.add('is-active');
      cards[current].setAttribute('aria-hidden', 'false');
    }

    if (cards.length > 1) {
      if (prevIndex !== current && cards[prevIndex]) {
        cards[prevIndex].classList.add('is-prev');
      }
      if (nextIndex !== current && cards[nextIndex]) {
        cards[nextIndex].classList.add('is-next');
        if (nextIndex === prevIndex) {
          cards[nextIndex].classList.add('is-prev');
        }
      }
    }

    dots.forEach(function (dot, index) {
      if (index === current) {
        dot.classList.add('is-active');
        dot.setAttribute('aria-selected', 'true');
        dot.setAttribute('tabindex', '0');
        if (options && options.focusDot) {
          dot.focus();
        }
      } else {
        dot.classList.remove('is-active');
        dot.setAttribute('aria-selected', 'false');
        dot.setAttribute('tabindex', '-1');
      }
    });
  }

  updateCardStates();

  function setActive(nextIndex, options) {
    if (nextIndex === current) {
      return;
    }

    current = nextIndex;
    updateCardStates(options);
  }

  function showNext() {
    var next = (current + 1) % cards.length;
    setActive(next);
  }

  function stopTimer() {
    if (timer) {
      window.clearInterval(timer);
      timer = null;
    }
  }

  function startTimer() {
    stopTimer();
    timer = window.setInterval(showNext, interval);
  }

  dots.forEach(function (dot, index) {
    dot.addEventListener('click', function () {
      stopTimer();
      setActive(index);
      startTimer();
    });

    dot.addEventListener('keydown', function (event) {
      var key = event.key;
      if (key !== 'ArrowRight' && key !== 'ArrowLeft' && key !== 'Home' && key !== 'End') {
        return;
      }

      event.preventDefault();
      stopTimer();

      if (key === 'ArrowRight') {
        setActive((current + 1) % cards.length, { focusDot: true });
      } else if (key === 'ArrowLeft') {
        setActive((current - 1 + cards.length) % cards.length, { focusDot: true });
      } else if (key === 'Home') {
        setActive(0, { focusDot: true });
      } else if (key === 'End') {
        setActive(cards.length - 1, { focusDot: true });
      }

      startTimer();
    });
  });

  slider.addEventListener('mouseenter', stopTimer);
  slider.addEventListener('mouseleave', startTimer);
  slider.addEventListener('focusin', stopTimer);
  slider.addEventListener('focusout', startTimer);

  document.addEventListener('visibilitychange', function () {
    if (document.hidden) {
      stopTimer();
    } else {
      startTimer();
    }
  });

  startTimer();
})();
</script>
{% endblock %}
