{% extends "base.html" %}

{% block title %}Sand & Sky Tours{% endblock %}

{% block content %}
{% include "includes/hero.html" with hero=hero %}
{% include "includes/about.html" with about_section=about_section %}
{% include "includes/destinations.html" with destinations_section=destinations_section %}
{% include "includes/features.html" with features_section=features_section %}
{% include "includes/testimonials.html" %}
{% include "includes/gallery_marquee.html" with gallery_section=gallery_section %}
{% include "includes/blog_highlights.html" with blog_section=blog_section %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function () {
  var heroVideo = document.querySelector('[data-hero-video]');
  if (heroVideo) {
    heroVideo.muted = true;
    heroVideo.setAttribute('muted', '');

    function attemptPlay() {
      var playPromise = heroVideo.play();
      if (playPromise && playPromise.catch) {
        playPromise.catch(function (err) {
          console.warn('Hero video playback blocked:', err);
          heroVideo.setAttribute('data-hero-video-blocked', 'true');
        });
      }
    }

    if (heroVideo.readyState >= 2) {
      attemptPlay();
    } else {
      heroVideo.addEventListener('loadeddata', attemptPlay, { once: true });
    }

    heroVideo.addEventListener('error', function (event) {
      console.error('Hero video failed to load', event);
      heroVideo.setAttribute('data-hero-video-error', 'true');
    });
  }

  var slider = document.querySelector('[data-testimonials]');
  if (!slider) {
    return;
  }

  var track = slider.querySelector('[data-testimonial-track]');
  if (!track) {
    return;
  }

  var dots = slider.querySelectorAll('[data-testimonial-dot]');
  var totalCards = track.querySelectorAll('[data-testimonial]').length;
  if (!totalCards) {
    return;
  }

  var interval = parseInt(slider.dataset.interval, 10);
  if (Number.isNaN(interval) || interval <= 0) {
    interval = 6000;
  }

  var timer = null;
  var isAnimating = false;
  var pendingShifts = 0;
  var appendedClones = [];

  function getGap() {
    var style = window.getComputedStyle(track);
    var value = style.columnGap || style.gap || '0';
    var parsed = parseFloat(value);
    return Number.isNaN(parsed) ? 0 : parsed;
  }

  function getStep() {
    var firstCard = track.querySelector('[data-testimonial]');
    if (!firstCard) {
      return 0;
    }
    var rect = firstCard.getBoundingClientRect();
    return rect.width + getGap();
  }

  function getCardsPerView() {
    if (window.matchMedia('(min-width: 1024px)').matches) {
      return 4;
    }
    if (window.matchMedia('(min-width: 640px)').matches) {
      return 2;
    }
    return 1;
  }

  function setDotState(dot, isActive) {
    if (!dot) {
      return;
    }

    if (isActive) {
      dot.classList.add('is-active');
      dot.setAttribute('aria-selected', 'true');
      dot.setAttribute('tabindex', '0');
    } else {
      dot.classList.remove('is-active');
      dot.setAttribute('aria-selected', 'false');
      dot.setAttribute('tabindex', '-1');
    }
  }

  function updateDots() {
    if (!dots.length) {
      return;
    }

    var firstVisible = track.querySelector('[data-testimonial]');
    if (!firstVisible) {
      return;
    }

    var activeIndex = parseInt(firstVisible.getAttribute('data-testimonial-index'), 10);
    if (Number.isNaN(activeIndex)) {
      activeIndex = 0;
    }

    dots.forEach(function (dot, index) {
      setDotState(dot, index === activeIndex);
    });
  }

  function updateVisibility() {
    var perView = Math.max(1, Math.min(getCardsPerView(), track.children.length));
    Array.prototype.forEach.call(track.children, function (card, idx) {
      card.setAttribute('aria-hidden', idx >= perView ? 'true' : 'false');
    });
  }

  function stopTimer() {
    if (timer) {
      window.clearInterval(timer);
      timer = null;
    }
  }

  function startTimer() {
    if (totalCards <= 1) {
      return;
    }

    stopTimer();
    timer = window.setInterval(function () {
      shift(1);
    }, interval);
  }

  function resetTrack() {
    if (!appendedClones.length) {
      return;
    }

    appendedClones.forEach(function (clone) {
      if (clone.parentNode === track) {
        track.removeChild(clone);
      }
    });
    appendedClones = [];
    pendingShifts = 0;
    isAnimating = false;
    track.style.transition = 'none';
    track.style.transform = 'translateX(0)';
    track.offsetHeight;
    track.style.transition = '';
  }

  function shift(count) {
    if (isAnimating) {
      return;
    }

    var step = getStep();
    if (!step) {
      return;
    }

    stopTimer();

    appendedClones = [];
    pendingShifts = 0;

    for (var i = 0; i < count; i += 1) {
      var source = track.children[i];
      if (!source) {
        break;
      }

      var clone = source.cloneNode(true);
      if (clone.id) {
        clone.dataset.originalId = clone.id;
        clone.removeAttribute('id');
      }
      clone.setAttribute('data-testimonial-clone', 'true');
      track.appendChild(clone);
      appendedClones.push(clone);
      pendingShifts += 1;
    }

    if (!pendingShifts) {
      startTimer();
      return;
    }

    requestAnimationFrame(function () {
      track.style.transition = 'transform 0.65s ease';
      track.style.transform = 'translateX(' + -(step * pendingShifts) + 'px)';
    });

    isAnimating = true;
  }

  track.addEventListener('transitionend', function (event) {
    if (event.target !== track || !isAnimating) {
      return;
    }

    track.style.transition = 'none';
    track.style.transform = 'translateX(0)';

    for (var i = 0; i < pendingShifts; i += 1) {
      if (!track.firstElementChild) {
        break;
      }
      track.removeChild(track.firstElementChild);
    }

    appendedClones.forEach(function (clone) {
      if (clone.dataset.originalId) {
        clone.id = clone.dataset.originalId;
        delete clone.dataset.originalId;
      }
      clone.removeAttribute('data-testimonial-clone');
    });

    appendedClones = [];
    pendingShifts = 0;
    isAnimating = false;

    updateVisibility();
    updateDots();

    track.offsetHeight;
    track.style.transition = '';

    startTimer();
  });

  dots.forEach(function (dot) {
    dot.addEventListener('click', function () {
      if (isAnimating) {
        return;
      }

      var controlId = dot.getAttribute('aria-controls');
      if (!controlId) {
        return;
      }

      var targetCard = slider.querySelector('#' + controlId);
      if (!targetCard) {
        return;
      }

      var order = Array.from(track.children);
      var distance = order.indexOf(targetCard);
      if (distance <= 0) {
        return;
      }

      shift(distance);
    });
  });

  dots.forEach(function (dot) {
    dot.addEventListener('keydown', function (event) {
      var key = event.key;
      if (key !== 'ArrowRight' && key !== 'ArrowLeft' && key !== 'Home' && key !== 'End') {
        return;
      }

      event.preventDefault();
      if (isAnimating) {
        return;
      }

      var firstCard = track.querySelector('[data-testimonial]');
      if (!firstCard) {
        return;
      }

      var currentIndex = parseInt(firstCard.getAttribute('data-testimonial-index'), 10) || 0;
      var targetIndex = currentIndex;

      if (key === 'ArrowRight') {
        targetIndex = (currentIndex + 1) % totalCards;
      } else if (key === 'ArrowLeft') {
        targetIndex = (currentIndex - 1 + totalCards) % totalCards;
      } else if (key === 'Home') {
        targetIndex = 0;
      } else if (key === 'End') {
        targetIndex = totalCards - 1;
      }

      if (targetIndex === currentIndex) {
        return;
      }

      var targetCard = slider.querySelector('[data-testimonial-index="' + targetIndex + '"]');
      if (!targetCard) {
        return;
      }

      var order = Array.from(track.children);
      var distance = order.indexOf(targetCard);
      if (distance <= 0) {
        distance += totalCards;
      }

      shift(distance);
    });
  });

  slider.addEventListener('mouseenter', function () {
    stopTimer();
  });

  slider.addEventListener('mouseleave', function () {
    if (!isAnimating) {
      startTimer();
    }
  });

  slider.addEventListener('focusin', stopTimer);
  slider.addEventListener('focusout', function (event) {
    if (!slider.contains(event.relatedTarget)) {
      startTimer();
    }
  });

  document.addEventListener('visibilitychange', function () {
    if (document.hidden) {
      stopTimer();
    } else if (!isAnimating) {
      startTimer();
    }
  });

  window.addEventListener('resize', function () {
    stopTimer();
    resetTrack();
    updateVisibility();
    updateDots();
    startTimer();
  });

  updateVisibility();
  updateDots();
  startTimer();
})();
</script>
{% endblock %}
